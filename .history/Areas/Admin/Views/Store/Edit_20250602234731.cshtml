@model JollibeeClone.Areas.Admin.Models.Store

@{
    ViewData["Title"] = "Chỉnh sửa cửa hàng";
}

@section Styles {
    <link rel="stylesheet" href="~/css/store-admin.css" asp-append-version="true" />
}

<div class="store-edit">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="page-title">
                <i class="fas fa-edit text-jollibee-red me-2"></i>
                Chỉnh sửa cửa hàng
            </h2>
            <p class="text-muted">Cập nhật thông tin cửa hàng: <strong>@Model.StoreName</strong></p>
        </div>
        <div class="btn-group">
            <a href="@Url.Action("Details", new { id = Model.StoreID })" class="btn btn-outline-info">
                <i class="fas fa-eye me-2"></i>
                Xem chi tiết
            </a>
            <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>
                Quay lại danh sách
            </a>
        </div>
    </div>

    <!-- Form -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Thông tin cửa hàng
                    </h5>
                </div>
                <div class="card-body">
                    <form id="storeForm" asp-action="Edit" method="post" enctype="multipart/form-data">
                        @Html.AntiForgeryToken()
                        <input asp-for="StoreID" type="hidden" />
                        <input asp-for="ImageUrl" type="hidden" />
                        
                        <!-- Tên cửa hàng -->
                        <div class="mb-3">
                            <label asp-for="StoreName" class="form-label required">Tên cửa hàng</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-store"></i>
                                </span>
                                <input asp-for="StoreName" class="form-control" placeholder="Nhập tên cửa hàng..." />
                            </div>
                            <span asp-validation-for="StoreName" class="text-danger"></span>
                        </div>

                        <!-- Địa chỉ -->
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label asp-for="StreetAddress" class="form-label required">Địa chỉ đường</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-road"></i>
                                    </span>
                                    <input asp-for="StreetAddress" class="form-control" placeholder="Số nhà, tên đường..." />
                                </div>
                                <span asp-validation-for="StreetAddress" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label required">Tỉnh/Thành phố</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-city"></i>
                                    </span>
                                    <select id="citySelect" class="form-select">
                                        <option value="">Chọn tỉnh/thành phố...</option>
                                    </select>
                                </div>
                                <input type="hidden" asp-for="City" />
                                <span asp-validation-for="City" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label required">Quận/Huyện</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-map"></i>
                                    </span>
                                    <select id="districtSelect" class="form-select" disabled>
                                        <option value="">Chọn quận/huyện...</option>
                                    </select>
                                </div>
                                <input type="hidden" asp-for="District" />
                                <span asp-validation-for="District" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Phường/Xã</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-map-pin"></i>
                                    </span>
                                    <select id="wardSelect" class="form-select" disabled>
                                        <option value="">Chọn phường/xã...</option>
                                    </select>
                                </div>
                                <input type="hidden" asp-for="Ward" />
                                <span asp-validation-for="Ward" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Thông tin liên hệ -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="PhoneNumber" class="form-label">Số điện thoại</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-phone"></i>
                                    </span>
                                    <input asp-for="PhoneNumber" class="form-control" placeholder="Số điện thoại liên hệ..." />
                                </div>
                                <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="OpeningHours" class="form-label">Giờ mở cửa</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-clock"></i>
                                    </span>
                                    <input asp-for="OpeningHours" class="form-control" placeholder="VD: 6:00 - 22:00" />
                                </div>
                                <span asp-validation-for="OpeningHours" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Trạng thái -->
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input asp-for="IsActive" class="form-check-input" />
                                <label asp-for="IsActive" class="form-check-label">
                                    Cửa hàng đang hoạt động
                                </label>
                            </div>
                        </div>

                        <!-- Submit buttons -->
                        <div class="d-flex justify-content-end gap-2">
                            <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>
                                Hủy bỏ
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>
                                Cập nhật cửa hàng
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Preview Panel -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-image me-2"></i>
                        Hình ảnh cửa hàng
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Current Image -->
                    @if (!string.IsNullOrEmpty(Model.ImageUrl))
                    {
                        <div class="current-image mb-3">
                            <label class="form-label">Ảnh hiện tại:</label>
                            <div class="current-image-container">
                                <img src="@Model.ImageUrl" alt="@Model.StoreName" class="current-image-display" 
                                     onerror="this.onerror=null; this.src='/assets/images/bee.png';" />
                                <div class="image-overlay">
                                    <button type="button" class="btn btn-sm btn-danger" id="removeCurrentImage">
                                        <i class="fas fa-trash"></i>
                                        Xóa ảnh
                                    </button>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Image Upload -->
                    <div class="mb-3">
                        <label class="form-label">@(string.IsNullOrEmpty(Model.ImageUrl) ? "Chọn ảnh cửa hàng" : "Thay đổi ảnh cửa hàng")</label>
                        <div class="image-upload-section">
                            <div class="file-upload-area" id="fileUploadArea" style="@(string.IsNullOrEmpty(Model.ImageUrl) ? "" : "display: none;")">
                                <div class="file-upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <p><strong>Kéo thả ảnh vào đây</strong></p>
                                <p>hoặc</p>
                                <label for="imageFile" class="btn btn-outline-primary">
                                    <i class="fas fa-folder-open me-2"></i>
                                    Chọn file ảnh mới
                                </label>
                                <input type="file" id="imageFile" name="imageFile" accept="image/*" style="display: none;" />
                                
                                @* <!-- Existing image options -->
                                <div class="mt-3">
                                    <p class="text-muted mb-2">hoặc chọn từ ảnh có sẵn:</p>
                                    <select id="existingImageSelect" class="form-select">
                                        <option value="">-- Chọn ảnh có sẵn --</option>
                                        <option value="/assets/images/stores/store-1.jpg">Cửa hàng mẫu 1</option>
                                        <option value="/assets/images/stores/store-2.jpg">Cửa hàng mẫu 2</option>
                                        <option value="/assets/images/stores/store-3.jpg">Cửa hàng mẫu 3</option>
                                        <option value="/assets/images/bee.png">Logo Jollibee</option>
                                    </select>
                                </div>
                            </div> *@
                            
                            <!-- New Image Preview -->
                            <div id="imagePreview" class="image-preview" style="display: none;">
                                <div class="image-preview-container">
                                    <img id="previewImg" src="#" alt="Preview" class="preview-image-full" />
                                    <div class="image-actions">
                                        <button type="button" class="btn btn-sm btn-light" id="changeImage" title="Thay đổi ảnh">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-danger" id="removeImage" title="Xóa ảnh">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Upload hint -->
                            <div class="image-upload-hint">
                                <small>
                                    <i class="fas fa-info-circle me-1"></i>
                                    Định dạng hỗ trợ: JPG, PNG, GIF, WEBP (tối đa 5MB)
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Store Preview -->
                    <div class="store-preview">
                        <h6>Preview cửa hàng:</h6>
                        <div class="preview-card">
                            <div class="preview-image">
                                <img id="previewImg" src="@(!string.IsNullOrEmpty(Model.ImageUrl) ? Model.ImageUrl : "/assets/images/bee.png")" alt="Preview" />
                            </div>
                            <div class="preview-content">
                                <h6 id="previewName">@Model.StoreName</h6>
                                <div class="preview-address">
                                    <i class="fas fa-map-marker-alt text-jollibee-red me-1"></i>
                                    <span id="previewAddress">@($"{Model.StreetAddress}, {(!string.IsNullOrEmpty(Model.Ward) ? Model.Ward + ", " : "")}{Model.District}, {Model.City}")</span>
                                </div>
                                <div class="preview-status">
                                    <span class="badge @(Model.IsActive ? "bg-success" : "bg-secondary")" id="previewStatus">@(Model.IsActive ? "Hoạt động" : "Tạm dừng")</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Address Helper -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Hướng dẫn
                    </h5>
                </div>
                <div class="card-body">
                    <div class="address-guide">
                        <div class="guide-item">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <span>Chọn tỉnh/thành phố trước</span>
                        </div>
                        <div class="guide-item">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <span>Sau đó chọn quận/huyện</span>
                        </div>
                        <div class="guide-item">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <span>Cuối cùng chọn phường/xã (tùy chọn)</span>
                        </div>
                        <div class="guide-item">
                            <i class="fas fa-lightbulb text-warning me-2"></i>
                            <span>Thay đổi tỉnh sẽ reset các dropdown bên dưới</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        $(document).ready(function() {
            // Store current values
            const currentCity = '@Model.City';
            const currentDistrict = '@Model.District';
            const currentWard = '@Model.Ward';

            // Load provinces on page load
            loadProvinces();

            // Drag and Drop functionality
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInput = document.getElementById('imageFile');

            if (fileUploadArea) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    fileUploadArea.addEventListener(eventName, preventDefaults, false);
                });

                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                ['dragenter', 'dragover'].forEach(eventName => {
                    fileUploadArea.addEventListener(eventName, highlight, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    fileUploadArea.addEventListener(eventName, unhighlight, false);
                });

                function highlight(e) {
                    fileUploadArea.classList.add('dragover');
                }

                function unhighlight(e) {
                    fileUploadArea.classList.remove('dragover');
                }

                fileUploadArea.addEventListener('drop', handleDrop, false);

                function handleDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    
                    if (files.length > 0) {
                        fileInput.files = files;
                        handleImageSelect(files[0]);
                    }
                }

                // Click to upload
                fileUploadArea.addEventListener('click', () => {
                    fileInput.click();
                });
            }

            // File input change
            $('#imageFile').on('change', function() {
                const file = this.files[0];
                if (file) {
                    handleImageSelect(file);
                }
            });

            // Existing image select
            $('#existingImageSelect').on('change', function() {
                const imageUrl = $(this).val();
                if (imageUrl) {
                    showNewImagePreview(imageUrl);
                    $('#previewImg').attr('src', imageUrl);
                    // Clear file input
                    $('#imageFile').val('');
                }
            });

            // Image actions
            $('#changeImage').on('click', function(e) {
                e.stopPropagation();
                fileInput.click();
            });

            $('#removeImage').on('click', function(e) {
                e.stopPropagation();
                resetImageUpload();
            });

            function handleImageSelect(file) {
                // Validate file
                if (!file.type.startsWith('image/')) {
                    alert('Vui lòng chọn file ảnh!');
                    return;
                }

                if (file.size > 5 * 1024 * 1024) {
                    alert('Kích thước ảnh không được vượt quá 5MB!');
                    return;
                }

                // Preview image
                const reader = new FileReader();
                reader.onload = function(e) {
                    showNewImagePreview(e.target.result);
                    $('#previewImg').attr('src', e.target.result);
                };
                reader.readAsDataURL(file);

                // Clear existing image select
                $('#existingImageSelect').val('');
            }

            function showNewImagePreview(src) {
                $('#previewImg').attr('src', src);
                $('#imagePreview').show();
                $('#fileUploadArea').hide();
            }

            function resetImageUpload() {
                $('#imagePreview').hide();
                $('#fileUploadArea').show();
                $('#imageFile').val('');
                $('#existingImageSelect').val('');
                $('#previewImg').attr('src', '@(!string.IsNullOrEmpty(Model.ImageUrl) ? Model.ImageUrl : "/assets/images/bee.png")');
            }

            // Remove current image
            $('#removeCurrentImage').on('click', function() {
                if (confirm('Bạn có chắc muốn xóa ảnh hiện tại?')) {
                    $('.current-image').hide();
                    $('#previewImg').attr('src', '/assets/images/bee.png');
                    $('#fileUploadArea').show();
                    // Set a flag to indicate image should be removed
                    $('<input>').attr({
                        type: 'hidden',
                        name: 'removeImage',
                        value: 'true'
                    }).appendTo('#storeForm');
                }
            });

            // Form field previews
            $('#StoreName').on('input', function() {
                const name = $(this).val() || '@Model.StoreName';
                $('#previewName').text(name);
            });

            function updateAddressPreview() {
                const street = $('#StreetAddress').val();
                const ward = $('#wardSelect option:selected').text();
                const district = $('#districtSelect option:selected').text();
                const city = $('#citySelect option:selected').text();
                
                let address = '';
                if (street) address += street;
                if (ward && ward !== 'Chọn phường/xã...') address += (address ? ', ' : '') + ward;
                if (district && district !== 'Chọn quận/huyện...') address += (address ? ', ' : '') + district;
                if (city && city !== 'Chọn tỉnh/thành phố...') address += (address ? ', ' : '') + city;
                
                $('#previewAddress').text(address || 'Địa chỉ cửa hàng');
            }

            $('#StreetAddress, #citySelect, #districtSelect, #wardSelect').on('input change', updateAddressPreview);

            $('#IsActive').on('change', function() {
                const isActive = $(this).is(':checked');
                const badge = $('#previewStatus');
                if (isActive) {
                    badge.removeClass('bg-secondary').addClass('bg-success').text('Hoạt động');
                } else {
                    badge.removeClass('bg-success').addClass('bg-secondary').text('Tạm dừng');
                }
            });

            // Address cascade functionality
            $('#citySelect').on('change', function() {
                const provinceCode = $(this).val();
                $('#districtSelect').empty().append('<option value="">Chọn quận/huyện...</option>').prop('disabled', true);
                $('#wardSelect').empty().append('<option value="">Chọn phường/xã...</option>').prop('disabled', true);
                
                if (provinceCode) {
                    loadDistricts(provinceCode);
                }
                updateAddressPreview();
            });

            $('#districtSelect').on('change', function() {
                const districtCode = $(this).val();
                $('#wardSelect').empty().append('<option value="">Chọn phường/xã...</option>').prop('disabled', true);
                
                if (districtCode) {
                    loadWards(districtCode);
                }
                updateAddressPreview();
            });

            $('#wardSelect').on('change', function() {
                updateAddressPreview();
            });

            function resetImagePreview() {
                $('#imagePreview').html(`
                    <div class="upload-placeholder">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Chọn ảnh để tải lên</p>
                        <button type="button" class="btn btn-outline-primary" onclick="$('#imageFile').click()">
                            <i class="fas fa-plus me-2"></i>
                            Chọn ảnh mới
                        </button>
                    </div>
                `);
                $('#previewImg').attr('src', '@(!string.IsNullOrEmpty(Model.ImageUrl) ? Model.ImageUrl : "/assets/images/bee.png")');
            }

            // Update hidden fields with names before submit
            $('#storeForm').on('submit', function(e) {
                console.log('Edit form is being submitted...'); // Debug
                
                // Get selected values
                const selectedCityCode = $('#citySelect').val();
                const selectedDistrictCode = $('#districtSelect').val();
                const selectedWard = $('#wardSelect').val();
                
                // Get selected names
                const selectedCityName = $('#citySelect option:selected').text();
                const selectedDistrictName = $('#districtSelect option:selected').text();
                
                console.log('Selected values:', {
                    cityCode: selectedCityCode,
                    districtCode: selectedDistrictCode,
                    ward: selectedWard,
                    cityName: selectedCityName,
                    districtName: selectedDistrictName
                });
                
                // Update hidden input values with actual names
                if (selectedCityCode && selectedCityName !== 'Chọn tỉnh/thành phố...') {
                    $('input[name="City"]').val(selectedCityName);
                    console.log('Set City to:', selectedCityName);
                }
                
                if (selectedDistrictCode && selectedDistrictName !== 'Chọn quận/huyện...') {
                    $('input[name="District"]').val(selectedDistrictName);
                    console.log('Set District to:', selectedDistrictName);
                }
                
                if (selectedWard && selectedWard !== '') {
                    $('input[name="Ward"]').val(selectedWard);
                    console.log('Set Ward to:', selectedWard);
                }
                
                // Validate required fields
                let isValid = true;
                $('.form-control, .form-select').removeClass('is-invalid');
                
                const requiredFields = ['StoreName', 'StreetAddress'];
                requiredFields.forEach(function(fieldName) {
                    const field = $('input[name="' + fieldName + '"]');
                    if (!field.val() || field.val().trim() === '') {
                        field.addClass('is-invalid');
                        isValid = false;
                    }
                });
                
                // Check city and district
                if (!selectedCityCode) {
                    $('#citySelect').addClass('is-invalid');
                    isValid = false;
                }
                
                if (!selectedDistrictCode) {
                    $('#districtSelect').addClass('is-invalid');
                    isValid = false;
                }
                
                if (!isValid) {
                    e.preventDefault();
                    console.log('Edit form validation failed');
                    $('html, body').animate({
                        scrollTop: $('.is-invalid').first().offset().top - 100
                    }, 500);
                    return false;
                }
                
                console.log('Edit form validation passed, submitting...');
                return true;
            });

            // API Functions
            function loadProvinces() {
                $('#citySelect').html('<option value="">Đang tải...</option>').prop('disabled', true);
                
                $.ajax({
                    url: 'https://provinces.open-api.vn/api/',
                    method: 'GET',
                    success: function(data) {
                        $('#citySelect').empty().append('<option value="">Chọn tỉnh/thành phố...</option>').prop('disabled', false);
                        
                        let selectedProvinceCode = null;
                        data.forEach(function(province) {
                            const isSelected = province.name === currentCity;
                            $('#citySelect').append(`<option value="${province.code}" data-name="${province.name}" ${isSelected ? 'selected' : ''}>${province.name}</option>`);
                            if (isSelected) {
                                selectedProvinceCode = province.code;
                            }
                        });

                        // Load districts if city is selected
                        if (selectedProvinceCode) {
                            loadDistricts(selectedProvinceCode);
                        }
                    },
                    error: function() {
                        $('#citySelect').html('<option value="">Lỗi tải dữ liệu</option>');
                        console.error('Không thể tải danh sách tỉnh thành');
                    }
                });
            }

            function loadDistricts(provinceCode) {
                $('#districtSelect').html('<option value="">Đang tải...</option>').prop('disabled', true);
                
                $.ajax({
                    url: `https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`,
                    method: 'GET',
                    success: function(data) {
                        $('#districtSelect').empty().append('<option value="">Chọn quận/huyện...</option>').prop('disabled', false);
                        
                        let selectedDistrictCode = null;
                        if (data.districts) {
                            data.districts.forEach(function(district) {
                                const isSelected = district.name === currentDistrict;
                                $('#districtSelect').append(`<option value="${district.code}" data-name="${district.name}" ${isSelected ? 'selected' : ''}>${district.name}</option>`);
                                if (isSelected) {
                                    selectedDistrictCode = district.code;
                                }
                            });
                        }

                        // Load wards if district is selected
                        if (selectedDistrictCode) {
                            loadWards(selectedDistrictCode);
                        }
                    },
                    error: function() {
                        $('#districtSelect').html('<option value="">Lỗi tải dữ liệu</option>');
                        console.error('Không thể tải danh sách quận huyện');
                    }
                });
            }

            function loadWards(districtCode) {
                $('#wardSelect').html('<option value="">Đang tải...</option>').prop('disabled', true);
                
                $.ajax({
                    url: `https://provinces.open-api.vn/api/d/${districtCode}?depth=2`,
                    method: 'GET',
                    success: function(data) {
                        $('#wardSelect').empty().append('<option value="">Chọn phường/xã...</option>').prop('disabled', false);
                        
                        if (data.wards) {
                            data.wards.forEach(function(ward) {
                                const isSelected = ward.name === currentWard;
                                $('#wardSelect').append(`<option value="${ward.name}" ${isSelected ? 'selected' : ''}>${ward.name}</option>`);
                            });
                        }
                    },
                    error: function() {
                        $('#wardSelect').html('<option value="">Lỗi tải dữ liệu</option>');
                        console.error('Không thể tải danh sách phường xã');
                    }
                });
            }
        });
    </script>
} 