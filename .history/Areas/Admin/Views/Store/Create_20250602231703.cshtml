@model JollibeeClone.Areas.Admin.Models.Store

@{
    ViewData["Title"] = "Thêm cửa hàng mới";
}

@section Styles {
    <link rel="stylesheet" href="~/css/store-admin.css" asp-append-version="true" />
}

<div class="store-create">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="page-title">
                <i class="fas fa-plus-circle text-jollibee-red me-2"></i>
                Thêm cửa hàng mới
            </h2>
            <p class="text-muted">Điền thông tin để thêm cửa hàng mới vào hệ thống</p>
        </div>
        <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>
            Quay lại danh sách
        </a>
    </div>

    <!-- Form -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Thông tin cửa hàng
                    </h5>
                </div>
                <div class="card-body">
                    <form id="storeForm" asp-action="Create" method="post" enctype="multipart/form-data">
                        @Html.AntiForgeryToken()
                        
                        <!-- Tên cửa hàng -->
                        <div class="mb-3">
                            <label asp-for="StoreName" class="form-label required">Tên cửa hàng</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-store"></i>
                                </span>
                                <input asp-for="StoreName" class="form-control" placeholder="Nhập tên cửa hàng..." />
                            </div>
                            <span asp-validation-for="StoreName" class="text-danger"></span>
                        </div>

                        <!-- Địa chỉ -->
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label asp-for="StreetAddress" class="form-label required">Địa chỉ đường</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-road"></i>
                                    </span>
                                    <input asp-for="StreetAddress" class="form-control" placeholder="Số nhà, tên đường..." />
                                </div>
                                <span asp-validation-for="StreetAddress" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label required">Tỉnh/Thành phố</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-city"></i>
                                    </span>
                                    <select id="citySelect" class="form-select">
                                        <option value="">Chọn tỉnh/thành phố...</option>
                                    </select>
                                </div>
                                <input type="hidden" asp-for="City" />
                                <span asp-validation-for="City" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label required">Quận/Huyện</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-map"></i>
                                    </span>
                                    <select id="districtSelect" class="form-select" disabled>
                                        <option value="">Chọn quận/huyện...</option>
                                    </select>
                                </div>
                                <input type="hidden" asp-for="District" />
                                <span asp-validation-for="District" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Phường/Xã</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-map-pin"></i>
                                    </span>
                                    <select id="wardSelect" class="form-select" disabled>
                                        <option value="">Chọn phường/xã...</option>
                                    </select>
                                </div>
                                <input type="hidden" asp-for="Ward" />
                                <span asp-validation-for="Ward" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Thông tin liên hệ -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="PhoneNumber" class="form-label">Số điện thoại</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-phone"></i>
                                    </span>
                                    <input asp-for="PhoneNumber" class="form-control" placeholder="Số điện thoại liên hệ..." />
                                </div>
                                <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="OpeningHours" class="form-label">Giờ mở cửa</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-clock"></i>
                                    </span>
                                    <input asp-for="OpeningHours" class="form-control" placeholder="VD: 6:00 - 22:00" />
                                </div>
                                <span asp-validation-for="OpeningHours" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Trạng thái -->
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input asp-for="IsActive" class="form-check-input" />
                                <label asp-for="IsActive" class="form-check-label">
                                    Cửa hàng đang hoạt động
                                </label>
                            </div>
                        </div>

                        <!-- Submit buttons -->
                        <div class="d-flex justify-content-end gap-2">
                            <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>
                                Hủy bỏ
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>
                                Lưu cửa hàng
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Preview Panel -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-image me-2"></i>
                        Hình ảnh cửa hàng
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Image Upload Section -->
                    <div class="image-upload-section">
                        <div class="file-upload-area" id="fileUploadArea">
                            <div class="file-upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <p><strong>Kéo thả ảnh vào đây</strong></p>
                            <p>hoặc</p>
                            <label for="imageFile" class="btn btn-outline-primary">
                                <i class="fas fa-folder-open me-2"></i>
                                Chọn file ảnh
                            </label>
                            <input type="file" id="imageFile" name="imageFile" accept="image/*" style="display: none;" />
                            
                            @* <!-- Existing image options -->
                            <div class="mt-3">
                                <p class="text-muted mb-2">hoặc chọn từ ảnh có sẵn:</p>
                                <select id="existingImageSelect" class="form-select">
                                    <option value="">-- Chọn ảnh có sẵn --</option>
                                    <option value="/assets/images/stores/store-1.jpg">Cửa hàng mẫu 1</option>
                                    <option value="/assets/images/stores/store-2.jpg">Cửa hàng mẫu 2</option>
                                    <option value="/assets/images/stores/store-3.jpg">Cửa hàng mẫu 3</option>
                                    <option value="/assets/images/bee.png">Logo Jollibee</option>
                                </select>
                            </div>
                        </div> *@
                        
                        <!-- Image Preview -->
                        <div id="imagePreview" class="image-preview" style="display: none;">
                            <div class="image-preview-container">
                                <img id="previewImg" src="#" alt="Preview" class="preview-image-full" />
                                <div class="image-actions">
                                    <button type="button" class="btn btn-sm btn-light" id="changeImage" title="Thay đổi ảnh">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger" id="removeImage" title="Xóa ảnh">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Upload hint -->
                        <div class="image-upload-hint">
                            <small>
                                <i class="fas fa-info-circle me-1"></i>
                                Định dạng hỗ trợ: JPG, PNG, GIF, WEBP (tối đa 5MB)
                            </small>
                        </div>
                    </div>

                    <!-- Store Preview -->
                    <div class="store-preview">
                        <h6><i class="fas fa-eye me-2"></i>Preview cửa hàng:</h6>
                        <div class="preview-card">
                            <div class="preview-image">
                                <img id="storePreviewImg" src="/assets/images/bee.png" alt="Preview" />
                            </div>
                            <div class="preview-content">
                                <h6 id="previewName">Tên cửa hàng</h6>
                                <div class="preview-address">
                                    <i class="fas fa-map-marker-alt text-jollibee-red me-1"></i>
                                    <span id="previewAddress">Địa chỉ cửa hàng</span>
                                </div>
                                <div class="preview-status">
                                    <span class="badge bg-success" id="previewStatus">Hoạt động</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Address Helper -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Hướng dẫn
                    </h5>
                </div>
                <div class="card-body">
                    <div class="address-guide">
                        <div class="guide-item">
                            <i class="fas fa-check-circle text-success"></i>
                            <span>Chọn tỉnh/thành phố trước</span>
                        </div>
                        <div class="guide-item">
                            <i class="fas fa-check-circle text-success"></i>
                            <span>Sau đó chọn quận/huyện</span>
                        </div>
                        <div class="guide-item">
                            <i class="fas fa-check-circle text-success"></i>
                            <span>Cuối cùng chọn phường/xã (tùy chọn)</span>
                        </div>
                        <div class="guide-item">
                            <i class="fas fa-lightbulb text-warning"></i>
                            <span>Điền đầy đủ để dễ dàng tìm kiếm</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        $(document).ready(function() {
            // Load provinces on page load
            loadProvinces();

            // Drag and Drop functionality
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInput = document.getElementById('imageFile');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                fileUploadArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                fileUploadArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                fileUploadArea.addEventListener(eventName, unhighlight, false);
            });

            function highlight(e) {
                fileUploadArea.classList.add('dragover');
            }

            function unhighlight(e) {
                fileUploadArea.classList.remove('dragover');
            }

            fileUploadArea.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    fileInput.files = files;
                    handleImageSelect(files[0]);
                }
            }

            // Click to upload
            fileUploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            // File input change
            $('#imageFile').on('change', function() {
                const file = this.files[0];
                if (file) {
                    handleImageSelect(file);
                }
            });

            // Existing image select
            $('#existingImageSelect').on('change', function() {
                const imageUrl = $(this).val();
                if (imageUrl) {
                    showImagePreview(imageUrl);
                    $('#storePreviewImg').attr('src', imageUrl);
                    // Clear file input
                    $('#imageFile').val('');
                }
            });

            // Image actions
            $('#changeImage').on('click', function(e) {
                e.stopPropagation();
                fileInput.click();
            });

            $('#removeImage').on('click', function(e) {
                e.stopPropagation();
                resetImageUpload();
            });

            function handleImageSelect(file) {
                // Validate file
                if (!file.type.startsWith('image/')) {
                    alert('Vui lòng chọn file ảnh!');
                    return;
                }

                if (file.size > 5 * 1024 * 1024) {
                    alert('Kích thước ảnh không được vượt quá 5MB!');
                    return;
                }

                // Preview image
                const reader = new FileReader();
                reader.onload = function(e) {
                    showImagePreview(e.target.result);
                    $('#storePreviewImg').attr('src', e.target.result);
                };
                reader.readAsDataURL(file);

                // Clear existing image select
                $('#existingImageSelect').val('');
            }

            function showImagePreview(src) {
                $('#previewImg').attr('src', src);
                $('#imagePreview').show();
                $('#fileUploadArea').hide();
            }

            function resetImageUpload() {
                $('#imagePreview').hide();
                $('#fileUploadArea').show();
                $('#imageFile').val('');
                $('#existingImageSelect').val('');
                $('#storePreviewImg').attr('src', '/assets/images/bee.png');
            }

            // Form field previews
            $('#StoreName').on('input', function() {
                const name = $(this).val() || 'Tên cửa hàng';
                $('#previewName').text(name);
            });

            function updateAddressPreview() {
                const street = $('#StreetAddress').val();
                const ward = $('#wardSelect option:selected').text();
                const district = $('#districtSelect option:selected').text();
                const city = $('#citySelect option:selected').text();
                
                let address = '';
                if (street) address += street;
                if (ward && ward !== 'Chọn phường/xã...') address += (address ? ', ' : '') + ward;
                if (district && district !== 'Chọn quận/huyện...') address += (address ? ', ' : '') + district;
                if (city && city !== 'Chọn tỉnh/thành phố...') address += (address ? ', ' : '') + city;
                
                $('#previewAddress').text(address || 'Địa chỉ cửa hàng');
            }

            $('#StreetAddress, #citySelect, #districtSelect, #wardSelect').on('input change', updateAddressPreview);

            $('#IsActive').on('change', function() {
                const isActive = $(this).is(':checked');
                const badge = $('#previewStatus');
                if (isActive) {
                    badge.removeClass('bg-secondary').addClass('bg-success').text('Hoạt động');
                } else {
                    badge.removeClass('bg-success').addClass('bg-secondary').text('Tạm dừng');
                }
            });

            // Address cascade functionality
            $('#citySelect').on('change', function() {
                const provinceCode = $(this).val();
                $('#districtSelect').empty().append('<option value="">Chọn quận/huyện...</option>').prop('disabled', true);
                $('#wardSelect').empty().append('<option value="">Chọn phường/xã...</option>').prop('disabled', true);
                
                if (provinceCode) {
                    loadDistricts(provinceCode);
                }
                updateAddressPreview();
            });

            $('#districtSelect').on('change', function() {
                const districtCode = $(this).val();
                $('#wardSelect').empty().append('<option value="">Chọn phường/xã...</option>').prop('disabled', true);
                
                if (districtCode) {
                    loadWards(districtCode);
                }
                updateAddressPreview();
            });

            $('#wardSelect').on('change', function() {
                updateAddressPreview();
            });

            // Debug: Log all form data before submit
            $('#storeForm').on('submit', function(e) {
                console.log('=== FORM SUBMISSION DEBUG ===');
                
                // Log all form fields
                const formData = new FormData(this);
                console.log('Form data:');
                for (let pair of formData.entries()) {
                    console.log(pair[0] + ': ' + pair[1]);
                }
                
                // Log select values
                console.log('Select values:');
                console.log('City select value:', $('#citySelect').val());
                console.log('City select text:', $('#citySelect option:selected').text());
                console.log('District select value:', $('#districtSelect').val()); 
                console.log('District select text:', $('#districtSelect option:selected').text());
                console.log('Ward select value:', $('#wardSelect').val());
                
                // Get the actual form input values
                console.log('Input field values:');
                console.log('StoreName:', $('input[name="StoreName"]').val());
                console.log('StreetAddress:', $('input[name="StreetAddress"]').val());
                console.log('City:', $('input[name="City"]').val());
                console.log('District:', $('input[name="District"]').val());
                console.log('Ward:', $('input[name="Ward"]').val());
                
                // Now update the hidden fields
                const cityText = $('#citySelect option:selected').text();
                const districtText = $('#districtSelect option:selected').text();
                const wardValue = $('#wardSelect').val();
                
                if (cityText && cityText !== 'Chọn tỉnh/thành phố...' && cityText !== 'Đang tải...') {
                    $('input[name="City"]').val(cityText);
                    console.log('Updated City to:', cityText);
                }
                
                if (districtText && districtText !== 'Chọn quận/huyện...' && districtText !== 'Đang tải...') {
                    $('input[name="District"]').val(districtText);
                    console.log('Updated District to:', districtText);
                }
                
                if (wardValue && wardValue !== '') {
                    $('input[name="Ward"]').val(wardValue);
                    console.log('Updated Ward to:', wardValue);
                }
                
                // Final validation
                let isValid = true;
                const errors = [];
                
                $('.form-control, .form-select').removeClass('is-invalid');
                
                // Check required fields
                if (!$('input[name="StoreName"]').val().trim()) {
                    errors.push('Tên cửa hàng là bắt buộc');
                    $('input[name="StoreName"]').addClass('is-invalid');
                    isValid = false;
                }
                
                if (!$('input[name="StreetAddress"]').val().trim()) {
                    errors.push('Địa chỉ là bắt buộc');
                    $('input[name="StreetAddress"]').addClass('is-invalid');
                    isValid = false;
                }
                
                if (!$('#citySelect').val()) {
                    errors.push('Thành phố là bắt buộc');
                    $('#citySelect').addClass('is-invalid');
                    isValid = false;
                }
                
                if (!$('#districtSelect').val()) {
                    errors.push('Quận/Huyện là bắt buộc');
                    $('#districtSelect').addClass('is-invalid');
                    isValid = false;
                }
                
                console.log('Validation result:', isValid);
                if (!isValid) {
                    console.log('Validation errors:', errors);
                    e.preventDefault();
                    alert('Vui lòng kiểm tra lại thông tin:\n' + errors.join('\n'));
                    return false;
                }
                
                console.log('=== FORM READY TO SUBMIT ===');
                return true;
            });

            // API Functions
            function loadProvinces() {
                $('#citySelect').html('<option value="">Đang tải...</option>').prop('disabled', true);
                
                $.ajax({
                    url: 'https://provinces.open-api.vn/api/',
                    method: 'GET',
                    success: function(data) {
                        $('#citySelect').empty().append('<option value="">Chọn tỉnh/thành phố...</option>').prop('disabled', false);
                        
                        data.forEach(function(province) {
                            $('#citySelect').append(`<option value="${province.code}" data-name="${province.name}">${province.name}</option>`);
                        });
                    },
                    error: function() {
                        $('#citySelect').html('<option value="">Lỗi tải dữ liệu</option>');
                        console.error('Không thể tải danh sách tỉnh thành');
                    }
                });
            }

            function loadDistricts(provinceCode) {
                $('#districtSelect').html('<option value="">Đang tải...</option>').prop('disabled', true);
                
                $.ajax({
                    url: `https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`,
                    method: 'GET',
                    success: function(data) {
                        $('#districtSelect').empty().append('<option value="">Chọn quận/huyện...</option>').prop('disabled', false);
                        
                        if (data.districts) {
                            data.districts.forEach(function(district) {
                                $('#districtSelect').append(`<option value="${district.code}" data-name="${district.name}">${district.name}</option>`);
                            });
                        }
                    },
                    error: function() {
                        $('#districtSelect').html('<option value="">Lỗi tải dữ liệu</option>');
                        console.error('Không thể tải danh sách quận huyện');
                    }
                });
            }

            function loadWards(districtCode) {
                $('#wardSelect').html('<option value="">Đang tải...</option>').prop('disabled', true);
                
                $.ajax({
                    url: `https://provinces.open-api.vn/api/d/${districtCode}?depth=2`,
                    method: 'GET',
                    success: function(data) {
                        $('#wardSelect').empty().append('<option value="">Chọn phường/xã...</option>').prop('disabled', false);
                        
                        if (data.wards) {
                            data.wards.forEach(function(ward) {
                                $('#wardSelect').append(`<option value="${ward.name}">${ward.name}</option>`);
                            });
                        }
                    },
                    error: function() {
                        $('#wardSelect').html('<option value="">Lỗi tải dữ liệu</option>');
                        console.error('Không thể tải danh sách phường xã');
                    }
                });
            }
        });
    </script>
} 