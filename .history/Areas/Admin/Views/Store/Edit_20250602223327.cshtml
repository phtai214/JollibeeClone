@model JollibeeClone.Areas.Admin.Models.Store

@{
    ViewData["Title"] = "Chỉnh sửa cửa hàng";
}

<div class="store-edit">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="page-title">
                <i class="fas fa-edit text-jollibee-red me-2"></i>
                Chỉnh sửa cửa hàng
            </h2>
            <p class="text-muted">Cập nhật thông tin cửa hàng: <strong>@Model.StoreName</strong></p>
        </div>
        <div class="btn-group">
            <a href="@Url.Action("Details", new { id = Model.StoreID })" class="btn btn-outline-info">
                <i class="fas fa-eye me-2"></i>
                Xem chi tiết
            </a>
            <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>
                Quay lại danh sách
            </a>
        </div>
    </div>

    <!-- Form -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Thông tin cửa hàng
                    </h5>
                </div>
                <div class="card-body">
                    <form id="storeForm" asp-action="Edit" method="post" enctype="multipart/form-data">
                        @Html.AntiForgeryToken()
                        <input asp-for="StoreID" type="hidden" />
                        <input asp-for="ImageUrl" type="hidden" />
                        
                        <!-- Tên cửa hàng -->
                        <div class="mb-3">
                            <label asp-for="StoreName" class="form-label required">Tên cửa hàng</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-store"></i>
                                </span>
                                <input asp-for="StoreName" class="form-control" placeholder="Nhập tên cửa hàng..." />
                            </div>
                            <span asp-validation-for="StoreName" class="text-danger"></span>
                        </div>

                        <!-- Địa chỉ -->
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label asp-for="StreetAddress" class="form-label required">Địa chỉ đường</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-road"></i>
                                    </span>
                                    <input asp-for="StreetAddress" class="form-control" placeholder="Số nhà, tên đường..." />
                                </div>
                                <span asp-validation-for="StreetAddress" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label asp-for="Ward" class="form-label">Phường/Xã</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-map-pin"></i>
                                    </span>
                                    <input asp-for="Ward" class="form-control" placeholder="Phường/Xã (không bắt buộc)" />
                                </div>
                                <span asp-validation-for="Ward" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="District" class="form-label required">Quận/Huyện</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-map"></i>
                                    </span>
                                    <input asp-for="District" class="form-control" placeholder="Quận/Huyện..." />
                                </div>
                                <span asp-validation-for="District" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="City" class="form-label required">Thành phố</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-city"></i>
                                    </span>
                                    <select asp-for="City" class="form-select">
                                        <option value="">Chọn thành phố...</option>
                                        <option value="Hồ Chí Minh">Hồ Chí Minh</option>
                                        <option value="Hà Nội">Hà Nội</option>
                                        <option value="Đà Nẵng">Đà Nẵng</option>
                                        <option value="Cần Thơ">Cần Thơ</option>
                                        <option value="Hải Phòng">Hải Phòng</option>
                                        <option value="Biên Hòa">Biên Hòa</option>
                                        <option value="Nha Trang">Nha Trang</option>
                                        <option value="Huế">Huế</option>
                                        <option value="Thủ Dầu Một">Thủ Dầu Một</option>
                                        <option value="Vũng Tàu">Vũng Tàu</option>
                                    </select>
                                </div>
                                <span asp-validation-for="City" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Thông tin liên hệ -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="PhoneNumber" class="form-label">Số điện thoại</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-phone"></i>
                                    </span>
                                    <input asp-for="PhoneNumber" class="form-control" placeholder="Số điện thoại liên hệ..." />
                                </div>
                                <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="OpeningHours" class="form-label">Giờ mở cửa</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-clock"></i>
                                    </span>
                                    <input asp-for="OpeningHours" class="form-control" placeholder="VD: 6:00 - 22:00" />
                                </div>
                                <span asp-validation-for="OpeningHours" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Tọa độ GPS -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Latitude" class="form-label">Vĩ độ (Latitude)</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-globe"></i>
                                    </span>
                                    <input asp-for="Latitude" class="form-control" step="any" placeholder="VD: 10.762622" />
                                    <button type="button" class="btn btn-outline-info" id="getCurrentLocation">
                                        <i class="fas fa-crosshairs"></i>
                                    </button>
                                </div>
                                <span asp-validation-for="Latitude" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Longitude" class="form-label">Kinh độ (Longitude)</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-globe"></i>
                                    </span>
                                    <input asp-for="Longitude" class="form-control" step="any" placeholder="VD: 106.660172" />
                                    <button type="button" class="btn btn-outline-primary" id="showOnMap">
                                        <i class="fas fa-map"></i>
                                    </button>
                                </div>
                                <span asp-validation-for="Longitude" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Trạng thái -->
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input asp-for="IsActive" class="form-check-input" />
                                <label asp-for="IsActive" class="form-check-label">
                                    Cửa hàng đang hoạt động
                                </label>
                            </div>
                        </div>

                        <!-- Submit buttons -->
                        <div class="d-flex justify-content-end gap-2">
                            <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>
                                Hủy bỏ
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>
                                Cập nhật cửa hàng
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Preview Panel -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-image me-2"></i>
                        Hình ảnh cửa hàng
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Current Image -->
                    @if (!string.IsNullOrEmpty(Model.ImageUrl))
                    {
                        <div class="current-image mb-3">
                            <label class="form-label">Ảnh hiện tại:</label>
                            <div class="current-image-container">
                                <img src="@Model.ImageUrl" alt="@Model.StoreName" class="current-image-display" 
                                     onerror="this.onerror=null; this.src='/assets/images/bee.png';" />
                                <div class="image-overlay">
                                    <button type="button" class="btn btn-sm btn-danger" id="removeCurrentImage">
                                        <i class="fas fa-trash"></i>
                                        Xóa ảnh
                                    </button>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Image Upload -->
                    <div class="mb-3">
                        <label class="form-label">@(string.IsNullOrEmpty(Model.ImageUrl) ? "Chọn ảnh cửa hàng" : "Thay đổi ảnh cửa hàng")</label>
                        <div class="image-upload-container">
                            <input type="file" id="imageFile" name="imageFile" accept=".jpg,.jpeg,.png,.gif,.webp" class="d-none" />
                            <div class="image-preview" id="imagePreview">
                                <div class="upload-placeholder">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">Chọn ảnh để tải lên</p>
                                    <button type="button" class="btn btn-outline-primary" onclick="$('#imageFile').click()">
                                        <i class="fas fa-plus me-2"></i>
                                        Chọn ảnh mới
                                    </button>
                                </div>
                            </div>
                        </div>
                        <small class="text-muted">Định dạng: JPG, PNG, GIF, WEBP (tối đa 5MB)</small>
                    </div>

                    <!-- Store Preview -->
                    <div class="store-preview">
                        <h6>Preview cửa hàng:</h6>
                        <div class="preview-card">
                            <div class="preview-image">
                                <img id="previewImg" src="@(!string.IsNullOrEmpty(Model.ImageUrl) ? Model.ImageUrl : "/assets/images/bee.png")" alt="Preview" />
                            </div>
                            <div class="preview-content">
                                <h6 id="previewName">@Model.StoreName</h6>
                                <div class="preview-address">
                                    <i class="fas fa-map-marker-alt text-jollibee-red me-1"></i>
                                    <span id="previewAddress">@($"{Model.StreetAddress}, {(!string.IsNullOrEmpty(Model.Ward) ? Model.Ward + ", " : "")}{Model.District}, {Model.City}")</span>
                                </div>
                                <div class="preview-status">
                                    <span class="badge @(Model.IsActive ? "bg-success" : "bg-secondary")" id="previewStatus">@(Model.IsActive ? "Hoạt động" : "Tạm dừng")</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map Preview -->
            @if (Model.Latitude.HasValue && Model.Longitude.HasValue)
            {
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-map-marked-alt me-2"></i>
                            Vị trí trên bản đồ
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="mapPreview" style="height: 200px; width: 100%; background: #f8f9fa; border-radius: 8px;"></div>
                    </div>
                </div>
            }
            else
            {
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-map-marked-alt me-2"></i>
                            Vị trí trên bản đồ
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="mapPreview" style="height: 200px; width: 100%; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                            <div class="text-center text-muted">
                                <i class="fas fa-map fa-2x mb-2"></i>
                                <p>Nhập tọa độ để xem vị trí</p>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- Map Modal -->
<div class="modal fade" id="mapModal" tabindex="-1" aria-labelledby="mapModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mapModalLabel">
                    <i class="fas fa-map-marked-alt me-2"></i>
                    Chọn vị trí trên bản đồ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="storeMap" style="height: 400px; width: 100%;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="confirmLocation">Xác nhận vị trí</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        $(document).ready(function() {
            // Initialize map preview if coordinates exist
            @if (Model.Latitude.HasValue && Model.Longitude.HasValue)
            {
                <text>
                if (typeof google !== 'undefined') {
                    const initialMap = new google.maps.Map(document.getElementById('mapPreview'), {
                        zoom: 15,
                        center: { lat: @Model.Latitude, lng: @Model.Longitude }
                    });
                    
                    new google.maps.Marker({
                        position: { lat: @Model.Latitude, lng: @Model.Longitude },
                        map: initialMap
                    });
                }
                </text>
            }

            // Image preview
            $('#imageFile').on('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        $('#imagePreview').html('<img src="' + e.target.result + '" alt="Preview" class="preview-image-full" />');
                        $('#previewImg').attr('src', e.target.result);
                    };
                    reader.readAsDataURL(file);
                } else {
                    resetImagePreview();
                }
            });

            // Remove current image
            $('#removeCurrentImage').on('click', function() {
                if (confirm('Bạn có chắc muốn xóa ảnh hiện tại?')) {
                    $('.current-image').hide();
                    $('#previewImg').attr('src', '/assets/images/bee.png');
                    // Set a flag to indicate image should be removed
                    $('<input>').attr({
                        type: 'hidden',
                        name: 'removeImage',
                        value: 'true'
                    }).appendTo('#storeForm');
                }
            });

            // Form field previews
            $('#StoreName').on('input', function() {
                const name = $(this).val() || '@Model.StoreName';
                $('#previewName').text(name);
            });

            function updateAddressPreview() {
                const street = $('#StreetAddress').val();
                const ward = $('#Ward').val();
                const district = $('#District').val();
                const city = $('#City').val();
                
                let address = '';
                if (street) address += street;
                if (ward) address += (address ? ', ' : '') + ward;
                if (district) address += (address ? ', ' : '') + district;
                if (city) address += (address ? ', ' : '') + city;
                
                $('#previewAddress').text(address || 'Địa chỉ cửa hàng');
            }

            $('#StreetAddress, #Ward, #District, #City').on('input change', updateAddressPreview);

            $('#IsActive').on('change', function() {
                const isActive = $(this).is(':checked');
                const badge = $('#previewStatus');
                if (isActive) {
                    badge.removeClass('bg-secondary').addClass('bg-success').text('Hoạt động');
                } else {
                    badge.removeClass('bg-success').addClass('bg-secondary').text('Tạm dừng');
                }
            });

            // GPS functionality
            $('#getCurrentLocation').on('click', function() {
                if (navigator.geolocation) {
                    $(this).html('<i class="fas fa-spinner fa-spin"></i>').prop('disabled', true);
                    
                    navigator.geolocation.getCurrentPosition(function(position) {
                        $('#Latitude').val(position.coords.latitude.toFixed(6));
                        $('#Longitude').val(position.coords.longitude.toFixed(6));
                        $('#getCurrentLocation').html('<i class="fas fa-check text-success"></i>').prop('disabled', false);
                        updateMapPreview();
                        
                        setTimeout(function() {
                            $('#getCurrentLocation').html('<i class="fas fa-crosshairs"></i>');
                        }, 2000);
                    }, function(error) {
                        $('#getCurrentLocation').html('<i class="fas fa-exclamation-triangle text-danger"></i>').prop('disabled', false);
                        alert('Không thể lấy vị trí hiện tại: ' + error.message);
                        
                        setTimeout(function() {
                            $('#getCurrentLocation').html('<i class="fas fa-crosshairs"></i>');
                        }, 2000);
                    });
                } else {
                    alert('Trình duyệt không hỗ trợ geolocation');
                }
            });

            // Map preview update
            $('#Latitude, #Longitude').on('input', function() {
                updateMapPreview();
            });

            function updateMapPreview() {
                const lat = parseFloat($('#Latitude').val());
                const lng = parseFloat($('#Longitude').val());
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    if (typeof google !== 'undefined') {
                        const map = new google.maps.Map(document.getElementById('mapPreview'), {
                            zoom: 15,
                            center: { lat: lat, lng: lng }
                        });
                        
                        new google.maps.Marker({
                            position: { lat: lat, lng: lng },
                            map: map
                        });
                    }
                }
            }

            $('#showOnMap').on('click', function() {
                const lat = parseFloat($('#Latitude').val()) || @((Model.Latitude ?? 10.762622m).ToString());
                const lng = parseFloat($('#Longitude').val()) || @((Model.Longitude ?? 106.660172m).ToString());
                
                $('#mapModal').modal('show');
                
                $('#mapModal').on('shown.bs.modal', function() {
                    if (typeof google !== 'undefined') {
                        const map = new google.maps.Map(document.getElementById('storeMap'), {
                            zoom: 15,
                            center: { lat: lat, lng: lng }
                        });
                        
                        const marker = new google.maps.Marker({
                            position: { lat: lat, lng: lng },
                            map: map,
                            draggable: true
                        });
                        
                        marker.addListener('dragend', function() {
                            const pos = marker.getPosition();
                            $('#Latitude').val(pos.lat().toFixed(6));
                            $('#Longitude').val(pos.lng().toFixed(6));
                        });
                    }
                });
            });

            function resetImagePreview() {
                $('#imagePreview').html(`
                    <div class="upload-placeholder">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Chọn ảnh để tải lên</p>
                        <button type="button" class="btn btn-outline-primary" onclick="$('#imageFile').click()">
                            <i class="fas fa-plus me-2"></i>
                            Chọn ảnh mới
                        </button>
                    </div>
                `);
                $('#previewImg').attr('src', '@(!string.IsNullOrEmpty(Model.ImageUrl) ? Model.ImageUrl : "/assets/images/bee.png")');
            }

            // Form validation
            $('#storeForm').on('submit', function(e) {
                let isValid = true;
                
                // Remove previous error styles
                $('.form-control, .form-select').removeClass('is-invalid');
                
                // Validate required fields
                const requiredFields = ['StoreName', 'StreetAddress', 'District', 'City'];
                requiredFields.forEach(function(fieldName) {
                    const field = $('#' + fieldName);
                    if (!field.val() || field.val().trim() === '') {
                        field.addClass('is-invalid');
                        isValid = false;
                    }
                });

                if (!isValid) {
                    e.preventDefault();
                    $('html, body').animate({
                        scrollTop: $('.is-invalid').first().offset().top - 100
                    }, 500);
                }
            });
        });
    </script>
}

@section Styles {
    <style>
        .required::after {
            content: " *";
            color: #dc3545;
        }

        .current-image-container {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
        }

        .current-image-display {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .current-image-container:hover .image-overlay {
            opacity: 1;
        }

        .image-upload-container {
            border: 2px dashed #e9ecef;
            border-radius: 8px;
            transition: border-color 0.3s ease;
        }

        .image-upload-container:hover {
            border-color: #dc2626;
        }

        .image-preview {
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .upload-placeholder {
            text-align: center;
        }

        .preview-image-full {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
        }

        .store-preview {
            margin-top: 20px;
        }

        .preview-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .preview-image {
            height: 120px;
            overflow: hidden;
        }

        .preview-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-content {
            padding: 15px;
        }

        .preview-content h6 {
            margin-bottom: 8px;
            font-weight: 600;
        }

        .preview-address {
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .text-jollibee-red {
            color: #dc2626 !important;
        }

        .btn-primary {
            background-color: #dc2626;
            border-color: #dc2626;
        }

        .btn-primary:hover {
            background-color: #b91c1c;
            border-color: #b91c1c;
        }

        .input-group-text {
            background-color: #f8f9fa;
            border-color: #e9ecef;
        }

        .form-control:focus, .form-select:focus {
            border-color: #dc2626;
            box-shadow: 0 0 0 0.2rem rgba(220, 38, 38, 0.25);
        }

        .is-invalid {
            border-color: #dc3545 !important;
        }

        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
    </style>
} 