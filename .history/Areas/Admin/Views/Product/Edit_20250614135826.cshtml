@model JollibeeClone.Models.Product

@{
    ViewData["Title"] = "Chỉnh sửa sản phẩm";
}

@section Styles {
    <link rel="stylesheet" href="~/css/product-admin.css" asp-append-version="true" />
}

<div class="edit-product">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="page-title">
                <i class="fas fa-edit text-primary me-2"></i>
                Chỉnh sửa sản phẩm
            </h2>
            <p class="text-muted">Cập nhật thông tin sản phẩm: <strong>@Model.ProductName</strong></p>
        </div>
        <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>
            Quay lại danh sách
        </a>
    </div>

    <!-- Hiá»ƒn thá»‹ lá»—i náº¿u cÃ³ -->
    @if (!ViewData.ModelState.IsValid)
    {
        <div class="alert alert-danger">
            <h6><i class="fas fa-exclamation-triangle me-2"></i>Vui lòng kiểm tra lại thông tin:</h6>
            <div asp-validation-summary="All" class="mb-0"></div>
        </div>
    }

    <!-- Form chá»‰nh sá»­a sáº£n pháº©m -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Thông tin sản phẩm
                    </h5>
                </div>
                <div class="card-body">
                    <form asp-action="Edit" method="post" enctype="multipart/form-data" id="editProductForm">
                        @Html.AntiForgeryToken()
                        <input asp-for="ProductID" type="hidden" />
                        
                        <div class="mb-3">
                            <label asp-for="ProductName" class="form-label required">TÃªn sáº£n pháº©m</label> 
                            <input asp-for="ProductName" class="form-control form-control-lg" placeholder="Nháº­p tÃªn sáº£n pháº©m..." required />
                            <span asp-validation-for="ProductName" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="ShortDescription" class="form-label">MÃ´ táº£ ngáº¯n</label>
                            <textarea asp-for="ShortDescription" class="form-control" rows="3" placeholder="Nháº­p mÃ´ táº£ ngáº¯n vá» sáº£n pháº©m..."></textarea>
                            <span asp-validation-for="ShortDescription" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Price" class="form-label required">GiÃ¡ bÃ¡n (VNÄ)</label>
                                    <div class="input-group">
                                        <input asp-for="Price" class="form-control" type="number" step="1000" min="1000" placeholder="0" required />
                                        <span class="input-group-text">Ä‘</span>
                                    </div>
                                    <span asp-validation-for="Price" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="OriginalPrice" class="form-label">GiÃ¡ gá»‘c (VNÄ)</label>
                                    <div class="input-group">
                                        <input asp-for="OriginalPrice" class="form-control" type="number" step="1000" min="0" placeholder="0" />
                                        <span class="input-group-text">Ä‘</span>
                                    </div>
                                    <div class="form-text">Äá»ƒ trá»‘ng náº¿u khÃ´ng cÃ³ giÃ¡ gá»‘c khÃ¡c</div>
                                    <span asp-validation-for="OriginalPrice" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="CategoryID" class="form-label required">Danh má»¥c</label>
                            <select asp-for="CategoryID" class="form-select" asp-items="ViewBag.CategoryID" required>
                                <option value="">-- Chá»n danh má»¥c --</option>
                            </select>
                            <span asp-validation-for="CategoryID" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input asp-for="IsConfigurable" class="form-check-input" type="checkbox" />
                                        <label asp-for="IsConfigurable" class="form-check-label">
                                            Sáº£n pháº©m cÃ³ thá»ƒ tÃ¹y chá»‰nh
                                        </label>
                                    </div>
                                    <div class="form-text">Cho phÃ©p khÃ¡ch hÃ ng tÃ¹y chá»‰nh sáº£n pháº©m (size, topping...)</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input asp-for="IsAvailable" class="form-check-input" type="checkbox" />
                                        <label asp-for="IsAvailable" class="form-check-label">
                                            Sáº£n pháº©m cÃ³ sáºµn
                                        </label>
                                    </div>
                                    <div class="form-text">Sáº£n pháº©m sáº½ hiá»ƒn thá»‹ cho khÃ¡ch hÃ ng</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save me-2"></i>
                                Cáº­p nháº­t sáº£n pháº©m
                            </button>
                            <a href="@Url.Action("Index")" class="btn btn-secondary btn-lg">
                                <i class="fas fa-times me-2"></i>
                                Há»§y
                            </a>
                        </div>
                        
                        <!-- Hidden file input inside form to ensure file is submitted -->
                        <input type="file" id="hiddenImageFile" name="imageFile" accept="image/*" style="display: none;" />
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- áº¢nh hiá»‡n táº¡i vÃ  upload áº£nh má»›i -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-image me-2"></i>
                        HÃ¬nh áº£nh sáº£n pháº©m
                    </h5>
                </div>
                <div class="card-body">
                    <!-- áº¢nh hiá»‡n táº¡i -->
                    @if (!string.IsNullOrEmpty(Model.ImageUrl))
                    {
                        <div class="mb-3">
                            <label class="form-label">áº¢nh hiá»‡n táº¡i:</label>
                            <div class="current-image-preview">
                                <img src="@Model.ImageUrl" alt="@Model.ProductName" class="img-fluid rounded shadow" style="max-height: 250px; width: 100%; object-fit: cover;" />
                                <div class="image-overlay">
                                    <button type="button" class="btn btn-sm btn-light" onclick="viewLargeImage('@Model.ImageUrl', '@Model.ProductName')">
                                        <i class="fas fa-search-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="mb-3">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Sáº£n pháº©m chÆ°a cÃ³ áº£nh
                            </div>
                        </div>
                    }

                    <!-- Upload áº£nh má»›i -->
                    <div class="image-upload-section">
                        <div class="file-upload-area" id="fileUploadArea">
                            <div class="file-upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <p><strong>@(string.IsNullOrEmpty(Model.ImageUrl) ? "Táº£i áº£nh lÃªn" : "Thay Ä‘á»•i áº£nh")</strong></p>
                            <p>KÃ©o tháº£ áº£nh vÃ o Ä‘Ã¢y hoáº·c</p>
                            <label for="imageFile" class="btn btn-outline-primary">
                                <i class="fas fa-folder-open me-2"></i>
                                Chá»n file tá»« mÃ¡y
                            </label>
                            <input type="file" id="imageFile" name="imageFile" accept="image/*" style="display: none;" />
                        </div>
                        
                        <div id="imagePreview" class="image-preview" style="display: none;">
                            <label class="form-label">áº¢nh má»›i:</label>
                            <img id="previewImg" src="#" alt="Preview" />
                            <div class="image-actions">
                                <button type="button" class="btn btn-sm btn-danger" id="removeImage">
                                    <i class="fas fa-trash"></i>
                                    XÃ³a áº£nh má»›i
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="upload-guidelines">
                        <h6><i class="fas fa-info-circle me-2"></i>HÆ°á»›ng dáº«n upload áº£nh:</h6>
                        <ul>
                            <li>KÃ­ch thÆ°á»›c tá»‘i Ä‘a: 5MB</li>
                            <li>Äá»‹nh dáº¡ng: JPG, PNG, GIF, WEBP</li>
                            <li>KÃ­ch thÆ°á»›c khuyáº¿n nghá»‹: 500x500px</li>
                            <li>Äá»ƒ trá»‘ng náº¿u khÃ´ng muá»‘n thay Ä‘á»•i áº£nh</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Preview giÃ¡ -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tag me-2"></i>
                        Preview giÃ¡
                    </h5>
                </div>
                <div class="card-body">
                    <div class="price-preview" id="pricePreview">
                        <div class="preview-price-display">
                            <span class="preview-current-price" id="previewCurrentPrice">@Model.Price.ToString("N0") Ä‘</span>
                            <span class="preview-original-price" id="previewOriginalPrice" style="@(Model.OriginalPrice.HasValue && Model.OriginalPrice > Model.Price ? "" : "display: none;")">@(Model.OriginalPrice?.ToString("N0")) Ä‘</span>
                            <span class="preview-discount" id="previewDiscount" style="@(Model.OriginalPrice.HasValue && Model.OriginalPrice > Model.Price ? "" : "display: none;")">@(Model.OriginalPrice.HasValue && Model.OriginalPrice > Model.Price ? "-" + Math.Round((decimal)(Model.OriginalPrice - Model.Price) / Model.OriginalPrice.Value * 100, 0) + "%" : "")</span>
                        </div>
                        <div class="price-preview-note">
                            <small class="text-muted">ÄÃ¢y lÃ  cÃ¡ch giÃ¡ sáº½ hiá»ƒn thá»‹ vá»›i khÃ¡ch hÃ ng</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>

    <script>
    $(document).ready(function() {
        // Form validation vÃ  submission handling
        $('#editProductForm').on('submit', function(e) {
            // Sync file to hidden input inside form
            var visibleImageFile = $('#imageFile')[0].files[0];
            if (visibleImageFile) {
                $('#hiddenImageFile')[0].files = $('#imageFile')[0].files;
            }
            
            // Basic client-side validation
            var isValid = true;
            var productName = $('#ProductName').val().trim();
            var price = parseFloat($('#Price').val());
            var categoryId = parseInt($('#CategoryID').val());
            
            if (!productName) {
                alert('Vui lÃ²ng nháº­p tÃªn sáº£n pháº©m!');
                $('#ProductName').focus();
                isValid = false;
            } else if (price <= 0) {
                alert('Vui lÃ²ng nháº­p giÃ¡ sáº£n pháº©m há»£p lá»‡!');
                $('#Price').focus();
                isValid = false;
            } else if (!categoryId || categoryId <= 0) {
                alert('Vui lÃ²ng chá»n danh má»¥c sáº£n pháº©m!');
                $('#CategoryID').focus();
                isValid = false;
            }
            
            if (!isValid) {
                e.preventDefault();
                return false;
            }
            
            // Show loading state
            var submitBtn = $(this).find('button[type="submit"]');
            var originalText = submitBtn.html();
            submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Äang cáº­p nháº­t...');
            
            // Reset on error (failsafe)
            setTimeout(function() {
                submitBtn.prop('disabled', false).html(originalText);
            }, 10000);
        });

        // Xá»­ lÃ½ upload áº£nh
        $('#imageFile').on('change', function(e) {
            var file = e.target.files[0];
            
            // Sync file to hidden input inside form
            if (file) {
                $('#hiddenImageFile')[0].files = this.files;
            } else {
                $('#hiddenImageFile').val('');
            }
            
            handleImageSelect(file);
        });

        $('#fileUploadArea').on('dragover', function(e) {
            e.preventDefault();
            $(this).addClass('drag-over');
        });

        $('#fileUploadArea').on('dragleave', function(e) {
            e.preventDefault();
            $(this).removeClass('drag-over');
        });

        $('#fileUploadArea').on('drop', function(e) {
            e.preventDefault();
            $(this).removeClass('drag-over');
            
            var files = e.originalEvent.dataTransfer.files;
            if (files.length > 0) {
                $('#imageFile')[0].files = files;
                $('#hiddenImageFile')[0].files = files; // Sync to hidden input
                handleImageSelect(files[0]);
            }
        });

        $('#fileUploadArea').on('click', function() {
            $('#imageFile').click();
        });

        $('#removeImage').on('click', function() {
            $('#imageFile').val('');
            $('#hiddenImageFile').val(''); // Clear hidden input too
            $('#imagePreview').hide();
            $('#fileUploadArea').show();
        });

        // Preview giÃ¡
        $('#Price, #OriginalPrice').on('input', function() {
            updatePricePreview();
        });

        function handleImageSelect(file) {
            if (!file) {
                return;
            }

            if (!file.type.match('image.*')) {
                alert('Vui lÃ²ng chá»n file áº£nh!');
                $('#imageFile').val('');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                alert('File áº£nh quÃ¡ lá»›n! Vui lÃ²ng chá»n file nhá» hÆ¡n 5MB.');
                $('#imageFile').val('');
                return;
            }

            var reader = new FileReader();
            reader.onload = function(e) {
                $('#previewImg').attr('src', e.target.result);
                $('#fileUploadArea').hide();
                $('#imagePreview').show();
            };
            reader.onerror = function() {
                alert('KhÃ´ng thá»ƒ Ä‘á»c file áº£nh!');
            };
            reader.readAsDataURL(file);
        }

        function updatePricePreview() {
            var currentPrice = parseFloat($('#Price').val()) || 0;
            var originalPrice = parseFloat($('#OriginalPrice').val()) || 0;

            // Format giÃ¡ theo VND
            var currentPriceText = currentPrice.toLocaleString('vi-VN') + ' Ä‘';
            $('#previewCurrentPrice').text(currentPriceText);

            if (originalPrice > 0 && originalPrice > currentPrice) {
                var originalPriceText = originalPrice.toLocaleString('vi-VN') + ' Ä‘';
                $('#previewOriginalPrice').text(originalPriceText).show();
                
                var discount = Math.round((originalPrice - currentPrice) / originalPrice * 100);
                $('#previewDiscount').text('-' + discount + '%').show();
            } else {
                $('#previewOriginalPrice').hide();
                $('#previewDiscount').hide();
            }
        }

        // Initialize price preview
        updatePricePreview();
    });

    // Function to view large image
    function viewLargeImage(imageUrl, productName) {
        var modal = `
            <div class="modal fade" id="imageModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${productName}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <img src="${imageUrl}" class="img-fluid" alt="${productName}">
                        </div>
                    </div>
                </div>
            </div>`;
        
        $('body').append(modal);
        $('#imageModal').modal('show');
        
        $('#imageModal').on('hidden.bs.modal', function() {
            $(this).remove();
        });
    }
    </script>
} 

