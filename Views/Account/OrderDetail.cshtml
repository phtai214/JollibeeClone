@model JollibeeClone.ViewModels.UserOrderDetailViewModel
@{
    ViewData["Title"] = $"Chi ti·∫øt ƒë∆°n h√†ng #{Model.OrderCode}";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="~/css/order-detail.css" rel="stylesheet" />

<div class="order-detail-container">
    <!-- Breadcrumb -->
    <div class="breadcrumb">
        <a href="@Url.Action("Orders")"><i class="fas fa-arrow-left"></i> Quay l·∫°i danh s√°ch ƒë∆°n h√†ng</a>
    </div>

    <!-- Order Header -->
    <div class="order-header">
        <div class="header-info">
            <h1>ƒê∆°n h√†ng #@Model.OrderCode</h1>
            <p class="order-date">
                <i class="far fa-calendar"></i>
                ƒê·∫∑t h√†ng l√∫c @Model.OrderDate.ToString("HH:mm dd/MM/yyyy")
            </p>
        </div>
        <div class="header-status">
            <span class="status-badge large" style="background-color: @Model.StatusColor; color: white;">
                <i class="@Model.StatusIcon"></i>
                @Model.StatusName
            </span>
        </div>
    </div>

    <div class="order-content">
        <div class="main-content">
            <!-- Order Timeline -->
            <div class="order-section">
                <h2> Tr·∫°ng th√°i ƒë∆°n h√†ng</h2>
                <div class="timeline">
                    @foreach (var trackingEvent in Model.TrackingEvents)
                    {
                        <div class="timeline-item @(trackingEvent.IsCompleted ? "completed" : "pending")">
                            <div class="timeline-marker" >
                                <i class="@trackingEvent.EventIcon" style="color: @trackingEvent.EventColor;"></i>
                            </div>
                            <div class="timeline-content">
                                <h4>@trackingEvent.EventTitle</h4>
                                <p>@trackingEvent.EventDescription</p>
                                @if (trackingEvent.EventDate != DateTime.MinValue)
                                {
                                    <time>@trackingEvent.EventDate.ToString("HH:mm dd/MM/yyyy")</time>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Order Items -->
            <div class="order-section">
                <h2><i class="fas fa-utensils"></i> S·∫£n ph·∫©m ƒë√£ ƒë·∫∑t</h2>
                <div class="order-items">
                    @foreach (var item in Model.OrderItems)
                    {
                        <div class="order-item">
                            <div class="item-image">
                                @if (!string.IsNullOrEmpty(item.ProductImage))
                                {
                                    <img src="@item.ProductImage" alt="@item.ProductName" />
                                }
                                else
                                {
                                    <div class="no-image">
                                        <i class="fas fa-utensils"></i>
                                    </div>
                                }
                            </div>
                            <div class="item-details">
                                <h3>@item.ProductName</h3>
                                
                                @if (item.ConfigurationOptions.Any())
                                {
                                    <div class="item-configurations">
                                        <h4>T√πy ch·ªçn:</h4>
                                        @foreach (var config in item.ConfigurationOptions.GroupBy(c => c.GroupName))
                                        {
                                            <div class="config-group">
                                                <span class="config-group-name">@config.Key:</span>
                                                <ul class="config-options">
                                                    @foreach (var option in config)
                                                    {
                                                        <li class="config-option">
                                                            <span class="option-name">@option.OptionName</span>
                                                            @if (!string.IsNullOrEmpty(option.VariantName))
                                                            {
                                                                <span class="variant-info">(@option.VariantName)</span>
                                                            }
                                                            @if (option.PriceAdjustment > 0)
                                                            {
                                                                <span class="price-adjustment">+@option.PriceAdjustment.ToString("N0")‚Ç´</span>
                                                            }
                                                        </li>
                                                    }
                                                </ul>
                                            </div>
                                        }
                                    </div>
                                }
                                
                                <div class="item-pricing">
                                    <span class="unit-price">@item.UnitPrice.ToString("N0")‚Ç´ x @item.Quantity</span>
                                    <span class="subtotal">@item.Subtotal.ToString("N0")‚Ç´</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Order Actions -->
            @if (Model.CanCancel || Model.CanReorder)
            {
                <div class="order-section">
                    <h2> Thao t√°c</h2>
                    <div class="order-actions">
                        @if (Model.CanReorder)
                        {
                            <button class="btn btn-primary" onclick="reorderItems(@Model.OrderID)">
                                <i class="fas fa-redo"></i>
                                ƒê·∫∑t l·∫°i ƒë∆°n h√†ng n√†y
                            </button>
                        }
                        
                        @if (Model.CanCancel)
                        {
                            <button class="btn btn-danger" onclick="cancelOrder(@Model.OrderID)">
                                <i class="fas fa-times"></i>
                                H·ªßy ƒë∆°n h√†ng
                            </button>
                        }
                    </div>
                </div>
            }
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Customer Information -->
            <div class="info-card">
                <h3><i class="fas fa-user"></i> Th√¥ng tin kh√°ch h√†ng</h3>
                <div class="info-content">
                    <div class="info-row">
                        <label>H·ªç t√™n:</label>
                        <span>@Model.CustomerFullName</span>
                    </div>
                    <div class="info-row">
                        <label>S·ªë ƒëi·ªán tho·∫°i:</label>
                        <span>@Model.CustomerPhoneNumber</span>
                    </div>
                    @if (!string.IsNullOrEmpty(Model.CustomerEmail))
                    {
                        <div class="info-row">
                            <label>Email:</label>
                            <span>@Model.CustomerEmail</span>
                        </div>
                    }
                </div>
            </div>

            <!-- Delivery Information -->
            <div class="info-card">
                @if (!string.IsNullOrEmpty(Model.StoreName))
                {
                    <!-- Pickup Order -->
                    <h3><i class="fas fa-store"></i> Th√¥ng tin nh·∫≠n h√†ng</h3>
                    <div class="info-content">
                        <div class="info-row">
                            <label>Ph∆∞∆°ng th·ª©c:</label>
                            <span>@Model.DeliveryMethodName</span>
                        </div>
                        
                        <div class="info-row">
                            <label>C·ª≠a h√†ng:</label>
                            <span>@Model.StoreName</span>
                        </div>
                        
                        @if (!string.IsNullOrEmpty(Model.StoreAddress))
                        {
                            <div class="info-row">
                                <label>ƒê·ªãa ch·ªâ c·ª≠a h√†ng:</label>
                                <span>@Model.StoreAddress</span>
                            </div>
                        }
                        
                        @if (Model.PickupDate.HasValue)
                        {
                            <div class="info-row">
                                <label>Ng√†y nh·∫≠n:</label>
                                <span>@Model.PickupDate.Value.ToString("dd/MM/yyyy")</span>
                            </div>
                        }
                        
                        @if (Model.PickupTimeSlot.HasValue)
                        {
                            <div class="info-row">
                                <label>Khung gi·ªù:</label>
                                <span>@Model.PickupTimeSlot.Value.ToString(@"hh\:mm")</span>
                            </div>
                        }
                    </div>
                }
                else if (!string.IsNullOrEmpty(Model.DeliveryAddress))
                {
                    <!-- Delivery Order -->
                    <h3><i class="fas fa-shipping-fast"></i> Th√¥ng tin giao h√†ng</h3>
                    <div class="info-content">
                        <div class="info-row">
                            <label>Ph∆∞∆°ng th·ª©c:</label>
                            <span>@Model.DeliveryMethodName</span>
                        </div>
                        
                        <div class="info-row">
                            <label>ƒê·ªãa ch·ªâ giao h√†ng:</label>
                            <span>@Model.DeliveryAddress</span>
                        </div>
                    </div>
                }
                else
                {
                    <!-- Fallback -->
                    <h3><i class="fas fa-shipping-fast"></i> Th√¥ng tin v·∫≠n chuy·ªÉn</h3>
                    <div class="info-content">
                        <div class="info-row">
                            <label>Ph∆∞∆°ng th·ª©c:</label>
                            <span>@Model.DeliveryMethodName</span>
                        </div>
                    </div>
                }
            </div>

            <!-- Payment Information -->
            <div class="info-card">
                <h3> Thanh to√°n</h3>
                <div class="info-content">
                    <div class="info-row">
                        <label>Ph∆∞∆°ng th·ª©c:</label>
                        <span>@Model.PaymentMethodName</span>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="info-card">
                <h3><i class="fas fa-receipt"></i> T·ªïng c·ªông</h3>
                <div class="order-summary">
                    <div class="summary-row">
                        <span>T·∫°m t√≠nh:</span>
                        <span>@Model.SubtotalAmount.ToString("N0")‚Ç´</span>
                    </div>
                    
                    @* Ch·ªâ hi·ªÉn th·ªã ph√≠ ship khi l√† delivery (giao h√†ng), kh√¥ng hi·ªÉn th·ªã khi pickup *@
                    @if (!string.IsNullOrEmpty(Model.DeliveryAddress))
                    {
                        @if (Model.ShippingFee > 0)
                        {
                            <div class="summary-row">
                                <span>Ph√≠ giao h√†ng:</span>
                                <span>@Model.ShippingFee.ToString("N0")‚Ç´</span>
                            </div>
                        }
                        else
                        {
                            <div class="summary-row">
                                <span>Ph√≠ giao h√†ng:</span>
                                <span style="color: #28a745;">Mi·ªÖn ph√≠</span>
                            </div>
                        }
                    }
                    
                    @if (Model.DiscountAmount > 0)
                    {
                        <div class="summary-row discount">
                            <span>Gi·∫£m gi√°:</span>
                            <span>-@Model.DiscountAmount.ToString("N0")‚Ç´</span>
                        </div>
                    }
                    
                    <div class="summary-row total">
                        <span>T·ªïng c·ªông:</span>
                        <span>@Model.TotalAmount.ToString("N0")‚Ç´</span>
                    </div>
                </div>
            </div>

            <!-- Notes -->
            @if (!string.IsNullOrEmpty(Model.NotesByCustomer))
            {
                <div class="info-card">
                    <h3><i class="fas fa-sticky-note"></i> Ghi ch√∫</h3>
                    <div class="info-content">
                        <p>@Model.NotesByCustomer</p>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let pollInterval;
        let currentOrderId = @Model.OrderID;
        let lastStatusName = '@Model.StatusName';
        
        $(document).ready(function() {
            // B·∫Øt ƒë·∫ßu polling tr·∫°ng th√°i ƒë∆°n h√†ng
            startOrderStatusPolling();
        });

        function startOrderStatusPolling() {
            // Polling m·ªói 10 gi√¢y ƒë·ªÉ ki·ªÉm tra tr·∫°ng th√°i m·ªõi
            pollInterval = setInterval(function() {
                checkOrderStatus();
            }, 1000); // 10 seconds

            console.log('‚úÖ Real-time order status polling started');
        }

        function stopOrderStatusPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                console.log('üõë Order status polling stopped');
            }
        }

        function checkOrderStatus() {
            fetch(`/Account/GetOrderStatus?orderId=${currentOrderId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateOrderStatus(data.data);
                    } else {
                        console.error('Error checking order status:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error checking order status:', error);
                });
        }

        function updateOrderStatus(statusData) {
            // Ki·ªÉm tra xem c√≥ thay ƒë·ªïi tr·∫°ng th√°i kh√¥ng
            if (statusData.statusName !== lastStatusName) {
                console.log(`üîÑ Status changed from "${lastStatusName}" to "${statusData.statusName}"`);
                
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i header
                updateStatusBadge(statusData);
                
                // C·∫≠p nh·∫≠t timeline
                updateTimeline(statusData.trackingEvents);
                
                // C·∫≠p nh·∫≠t n√∫t h√†nh ƒë·ªông
                updateActionButtons(statusData);
                
                // Hi·ªÉn th·ªã th√¥ng b√°o
                showStatusChangeNotification(lastStatusName, statusData.statusName);
                
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i hi·ªán t·∫°i
                lastStatusName = statusData.statusName;
            }
        }

        function updateStatusBadge(statusData) {
            const statusBadge = $('.status-badge.large');
            statusBadge.css('background-color', statusData.statusColor);
            statusBadge.html(`<i class="${statusData.statusIcon}"></i> ${statusData.statusName}`);
            
            // Th√™m hi·ªáu ·ª©ng pulse ƒë·ªÉ thu h√∫t s·ª± ch√∫ √Ω
            statusBadge.addClass('status-updated');
            setTimeout(() => {
                statusBadge.removeClass('status-updated');
            }, 2000);
        }

        function updateTimeline(trackingEvents) {
            const timeline = $('.timeline');
            timeline.empty();
            
            trackingEvents.forEach(event => {
                const timelineItem = $(`
                    <div class="timeline-item ${event.isCompleted ? 'completed' : 'pending'}">
                        <div class="timeline-marker">
                            <i class="${event.eventIcon}" style="color: ${event.eventColor};"></i>
                        </div>
                        <div class="timeline-content">
                            <h4>${event.eventTitle}</h4>
                            <p>${event.eventDescription}</p>
                            ${event.eventDate && event.eventDate !== '0001-01-01T00:00:00' ? 
                                `<time>${new Date(event.eventDate).toLocaleDateString('vi-VN', {
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: 'numeric'
                                })}</time>` : ''
                            }
                        </div>
                    </div>
                `);
                timeline.append(timelineItem);
            });
        }

        function updateActionButtons(statusData) {
            const actionSection = $('.order-actions');
            actionSection.empty();
            
            if (statusData.canReorder) {
                actionSection.append(`
                    <button class="btn btn-primary" onclick="reorderItems(${currentOrderId})">
                        <i class="fas fa-redo"></i>
                        ƒê·∫∑t l·∫°i ƒë∆°n h√†ng n√†y
                    </button>
                `);
            }
            
            if (statusData.canCancel) {
                actionSection.append(`
                    <button class="btn btn-danger" onclick="cancelOrder(${currentOrderId})">
                        <i class="fas fa-times"></i>
                        H·ªßy ƒë∆°n h√†ng
                    </button>
                `);
            }

            // ·∫®n/hi·ªán section n·∫øu kh√¥ng c√≥ n√∫t n√†o
            const orderSection = actionSection.closest('.order-section');
            if (actionSection.children().length === 0) {
                orderSection.hide();
            } else {
                orderSection.show();
            }
        }

         function showStatusChangeNotification(oldStatus, newStatus) {
            // T·∫°o toast notification
            const notification = $(`
                <div class="status-notification" style="
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #28a745;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 5px;
                    z-index: 9999;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    animation: slideInRight 0.5s ease-out;
                ">
                    <i class="fas fa-check-circle"></i>
                    <strong>Tr·∫°ng th√°i ƒë∆°n h√†ng ƒë√£ c·∫≠p nh·∫≠t!</strong><br>
                    <small>"${oldStatus}" ‚Üí "${newStatus}"</small>
                </div>
            `);
            
            $('body').append(notification);
            
            // T·ª± ƒë·ªông ·∫©n sau 5 gi√¢y
            setTimeout(() => {
                notification.fadeOut(500, function() {
                    $(this).remove();
                });
            }, 1000);
        } 

        function reorderItems(orderId) {
            if (confirm('B·∫°n c√≥ mu·ªën ƒë·∫∑t l·∫°i c√°c s·∫£n ph·∫©m trong ƒë∆°n h√†ng n√†y?')) {
                // Implementation for reordering
                window.location.href = '/Menu/MonNgonPhaiThu';
            }
        }

        function cancelOrder(orderId) {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n h√†ng n√†y?\n\nL∆∞u √Ω: \n- Ch·ªâ c√≥ th·ªÉ h·ªßy ƒë∆°n h√†ng khi ƒëang ·ªü tr·∫°ng th√°i "Ch·ªù x√°c nh·∫≠n"\n- ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n b·ªüi c·ª≠a h√†ng kh√¥ng th·ªÉ h·ªßy\n- ƒê∆°n h√†ng ƒë√£ h·ªßy kh√¥ng th·ªÉ kh√¥i ph·ª•c')) {
                // Implementation for canceling order
                fetch(`/Account/CancelOrder/${orderId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // C·∫≠p nh·∫≠t tr·∫°ng th√°i ngay l·∫≠p t·ª©c thay v√¨ chuy·ªÉn trang
                        checkOrderStatus();
                        showStatusChangeNotification(lastStatusName, 'ƒê√£ h·ªßy');
                    } else {
                        alert(data.message || 'C√≥ l·ªói x·∫£y ra khi h·ªßy ƒë∆°n h√†ng.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('C√≥ l·ªói x·∫£y ra khi h·ªßy ƒë∆°n h√†ng.');
                });
            }
        }

        // D·ª´ng polling khi r·ªùi kh·ªèi trang
        $(window).on('beforeunload', function() {
            stopOrderStatusPolling();
        });

        // D·ª´ng polling khi tab kh√¥ng ƒë∆∞·ª£c focus (t√πy ch·ªçn ƒë·ªÉ ti·∫øt ki·ªám t√†i nguy√™n)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopOrderStatusPolling();
                console.log('üîá Tab hidden - polling stopped');
            } else {
                startOrderStatusPolling();
                console.log('üîä Tab visible - polling resumed');
            }
        });
    </script>

    <style>
        /* Animation cho hi·ªáu ·ª©ng status update */
        .status-updated {
            animation: pulse 0.5s ease-in-out;
        }

        @@keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @@keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Hi·ªáu ·ª©ng hover cho timeline items */
        .timeline-item {
            transition: all 0.3s ease;
        }

        .timeline-item.completed {
            animation: fadeInUp 0.5s ease-in-out;
        }

        @@keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
} 