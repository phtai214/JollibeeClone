@model JollibeeClone.ViewModels.UserOrderDetailViewModel
@{
    ViewData["Title"] = $"Chi tiết đơn hàng #{Model.OrderCode}";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="~/css/order-detail.css" rel="stylesheet" />

<div class="order-detail-container">
    <!-- Breadcrumb -->
    <div class="breadcrumb">
        <a href="@Url.Action("Orders")"><i class="fas fa-arrow-left"></i> Quay lại danh sách đơn hàng</a>
    </div>

    <!-- Order Header -->
    <div class="order-header">
        <div class="header-info">
            <h1>Đơn hàng #@Model.OrderCode</h1>
            <p class="order-date">
                <i class="far fa-calendar"></i>
                Đặt hàng lúc @Model.OrderDate.ToString("HH:mm dd/MM/yyyy")
            </p>
        </div>
        <div class="header-status">
            <span class="status-badge large" style="background-color: @Model.StatusColor; color: white;">
                <i class="@Model.StatusIcon"></i>
                @Model.StatusName
            </span>
        </div>
    </div>

    <div class="order-content">
        <div class="main-content">
            <!-- Order Timeline -->
            <div class="order-section">
                <h2> Trạng thái đơn hàng</h2>
                <div class="timeline">
                    @foreach (var trackingEvent in Model.TrackingEvents)
                    {
                        <div class="timeline-item @(trackingEvent.IsCompleted ? "completed" : "pending")">
                            <div class="timeline-marker" >
                                <i class="@trackingEvent.EventIcon" style="color: @trackingEvent.EventColor;"></i>
                            </div>
                            <div class="timeline-content">
                                <h4>@trackingEvent.EventTitle</h4>
                                <p>@trackingEvent.EventDescription</p>
                                @if (trackingEvent.EventDate != DateTime.MinValue)
                                {
                                    <time>@trackingEvent.EventDate.ToString("HH:mm dd/MM/yyyy")</time>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Order Items -->
            <div class="order-section">
                <h2><i class="fas fa-utensils"></i> Sản phẩm đã đặt</h2>
                <div class="order-items">
                    @foreach (var item in Model.OrderItems)
                    {
                        <div class="order-item">
                            <div class="item-image">
                                @if (!string.IsNullOrEmpty(item.ProductImage))
                                {
                                    <img src="@item.ProductImage" alt="@item.ProductName" />
                                }
                                else
                                {
                                    <div class="no-image">
                                        <i class="fas fa-utensils"></i>
                                    </div>
                                }
                            </div>
                            <div class="item-details">
                                <h3>@item.ProductName</h3>
                                
                                @if (item.ConfigurationOptions.Any())
                                {
                                    <div class="item-configurations">
                                        <h4>Tùy chọn:</h4>
                                        @foreach (var config in item.ConfigurationOptions.GroupBy(c => c.GroupName))
                                        {
                                            <div class="config-group">
                                                <span class="config-group-name">@config.Key:</span>
                                                <ul class="config-options">
                                                    @foreach (var option in config)
                                                    {
                                                        <li class="config-option">
                                                            <span class="option-name">@option.OptionName</span>
                                                            @if (!string.IsNullOrEmpty(option.VariantName))
                                                            {
                                                                <span class="variant-info">(@option.VariantName)</span>
                                                            }
                                                            @if (option.PriceAdjustment > 0)
                                                            {
                                                                <span class="price-adjustment">+@option.PriceAdjustment.ToString("N0")₫</span>
                                                            }
                                                        </li>
                                                    }
                                                </ul>
                                            </div>
                                        }
                                    </div>
                                }
                                
                                <div class="item-pricing">
                                    <span class="unit-price">@item.UnitPrice.ToString("N0")₫ x @item.Quantity</span>
                                    <span class="subtotal">@item.Subtotal.ToString("N0")₫</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Order Actions -->
            @if (Model.CanCancel || Model.CanReorder)
            {
                <div class="order-section">
                    <h2> Thao tác</h2>
                    <div class="order-actions">
                        @if (Model.CanReorder)
                        {
                            <button class="btn btn-primary" onclick="reorderItems(@Model.OrderID)">
                                <i class="fas fa-redo"></i>
                                Đặt lại đơn hàng này
                            </button>
                        }
                        
                        @if (Model.CanCancel)
                        {
                            <button class="btn btn-danger" onclick="cancelOrder(@Model.OrderID)">
                                <i class="fas fa-times"></i>
                                Hủy đơn hàng
                            </button>
                        }
                    </div>
                </div>
            }
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Customer Information -->
            <div class="info-card">
                <h3><i class="fas fa-user"></i> Thông tin khách hàng</h3>
                <div class="info-content">
                    <div class="info-row">
                        <label>Họ tên:</label>
                        <span>@Model.CustomerFullName</span>
                    </div>
                    <div class="info-row">
                        <label>Số điện thoại:</label>
                        <span>@Model.CustomerPhoneNumber</span>
                    </div>
                    @if (!string.IsNullOrEmpty(Model.CustomerEmail))
                    {
                        <div class="info-row">
                            <label>Email:</label>
                            <span>@Model.CustomerEmail</span>
                        </div>
                    }
                </div>
            </div>

            <!-- Delivery Information -->
            <div class="info-card">
                @if (!string.IsNullOrEmpty(Model.StoreName))
                {
                    <!-- Pickup Order -->
                    <h3><i class="fas fa-store"></i> Thông tin nhận hàng</h3>
                    <div class="info-content">
                        <div class="info-row">
                            <label>Phương thức:</label>
                            <span>@Model.DeliveryMethodName</span>
                        </div>
                        
                        <div class="info-row">
                            <label>Cửa hàng:</label>
                            <span>@Model.StoreName</span>
                        </div>
                        
                        @if (!string.IsNullOrEmpty(Model.StoreAddress))
                        {
                            <div class="info-row">
                                <label>Địa chỉ cửa hàng:</label>
                                <span>@Model.StoreAddress</span>
                            </div>
                        }
                        
                        @if (Model.PickupDate.HasValue)
                        {
                            <div class="info-row">
                                <label>Ngày nhận:</label>
                                <span>@Model.PickupDate.Value.ToString("dd/MM/yyyy")</span>
                            </div>
                        }
                        
                        @if (Model.PickupTimeSlot.HasValue)
                        {
                            <div class="info-row">
                                <label>Khung giờ:</label>
                                <span>@Model.PickupTimeSlot.Value.ToString(@"hh\:mm")</span>
                            </div>
                        }
                    </div>
                }
                else if (!string.IsNullOrEmpty(Model.DeliveryAddress))
                {
                    <!-- Delivery Order -->
                    <h3><i class="fas fa-shipping-fast"></i> Thông tin giao hàng</h3>
                    <div class="info-content">
                        <div class="info-row">
                            <label>Phương thức:</label>
                            <span>@Model.DeliveryMethodName</span>
                        </div>
                        
                        <div class="info-row">
                            <label>Địa chỉ giao hàng:</label>
                            <span>@Model.DeliveryAddress</span>
                        </div>
                    </div>
                }
                else
                {
                    <!-- Fallback -->
                    <h3><i class="fas fa-shipping-fast"></i> Thông tin vận chuyển</h3>
                    <div class="info-content">
                        <div class="info-row">
                            <label>Phương thức:</label>
                            <span>@Model.DeliveryMethodName</span>
                        </div>
                    </div>
                }
            </div>

            <!-- Payment Information -->
            <div class="info-card">
                <h3> Thanh toán</h3>
                <div class="info-content">
                    <div class="info-row">
                        <label>Phương thức:</label>
                        <span>@Model.PaymentMethodName</span>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="info-card">
                <h3><i class="fas fa-receipt"></i> Tổng cộng</h3>
                <div class="order-summary">
                    <div class="summary-row">
                        <span>Tạm tính:</span>
                        <span>@Model.SubtotalAmount.ToString("N0")₫</span>
                    </div>
                    
                    @* Chỉ hiển thị phí ship khi là delivery (giao hàng), không hiển thị khi pickup *@
                    @if (!string.IsNullOrEmpty(Model.DeliveryAddress))
                    {
                        @if (Model.ShippingFee > 0)
                        {
                            <div class="summary-row">
                                <span>Phí giao hàng:</span>
                                <span>@Model.ShippingFee.ToString("N0")₫</span>
                            </div>
                        }
                        else
                        {
                            <div class="summary-row">
                                <span>Phí giao hàng:</span>
                                <span style="color: #28a745;">Miễn phí</span>
                            </div>
                        }
                    }
                    
                    @if (Model.DiscountAmount > 0)
                    {
                        <div class="summary-row discount">
                            <span>Giảm giá:</span>
                            <span>-@Model.DiscountAmount.ToString("N0")₫</span>
                        </div>
                    }
                    
                    <div class="summary-row total">
                        <span>Tổng cộng:</span>
                        <span>@Model.TotalAmount.ToString("N0")₫</span>
                    </div>
                </div>
            </div>

            <!-- Notes -->
            @if (!string.IsNullOrEmpty(Model.NotesByCustomer))
            {
                <div class="info-card">
                    <h3><i class="fas fa-sticky-note"></i> Ghi chú</h3>
                    <div class="info-content">
                        <p>@Model.NotesByCustomer</p>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let pollInterval;
        let currentOrderId = @Model.OrderID;
        let lastStatusName = '@Model.StatusName';
        
        $(document).ready(function() {
            // Bắt đầu polling trạng thái đơn hàng
            startOrderStatusPolling();
        });

        function startOrderStatusPolling() {
            // Polling mỗi 10 giây để kiểm tra trạng thái mới
            pollInterval = setInterval(function() {
                checkOrderStatus();
            }, 1000); // 10 seconds

            console.log('✅ Real-time order status polling started');
        }

        function stopOrderStatusPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                console.log('🛑 Order status polling stopped');
            }
        }

        function checkOrderStatus() {
            fetch(`/Account/GetOrderStatus?orderId=${currentOrderId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateOrderStatus(data.data);
                    } else {
                        console.error('Error checking order status:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error checking order status:', error);
                });
        }

        function updateOrderStatus(statusData) {
            // Kiểm tra xem có thay đổi trạng thái không
            if (statusData.statusName !== lastStatusName) {
                console.log(`🔄 Status changed from "${lastStatusName}" to "${statusData.statusName}"`);
                
                // Cập nhật trạng thái header
                updateStatusBadge(statusData);
                
                // Cập nhật timeline
                updateTimeline(statusData.trackingEvents);
                
                // Cập nhật nút hành động
                updateActionButtons(statusData);
                
                // Hiển thị thông báo
                showStatusChangeNotification(lastStatusName, statusData.statusName);
                
                // Cập nhật trạng thái hiện tại
                lastStatusName = statusData.statusName;
            }
        }

        function updateStatusBadge(statusData) {
            const statusBadge = $('.status-badge.large');
            statusBadge.css('background-color', statusData.statusColor);
            statusBadge.html(`<i class="${statusData.statusIcon}"></i> ${statusData.statusName}`);
            
            // Thêm hiệu ứng pulse để thu hút sự chú ý
            statusBadge.addClass('status-updated');
            setTimeout(() => {
                statusBadge.removeClass('status-updated');
            }, 2000);
        }

        function updateTimeline(trackingEvents) {
            const timeline = $('.timeline');
            timeline.empty();
            
            trackingEvents.forEach(event => {
                const timelineItem = $(`
                    <div class="timeline-item ${event.isCompleted ? 'completed' : 'pending'}">
                        <div class="timeline-marker">
                            <i class="${event.eventIcon}" style="color: ${event.eventColor};"></i>
                        </div>
                        <div class="timeline-content">
                            <h4>${event.eventTitle}</h4>
                            <p>${event.eventDescription}</p>
                            ${event.eventDate && event.eventDate !== '0001-01-01T00:00:00' ? 
                                `<time>${new Date(event.eventDate).toLocaleDateString('vi-VN', {
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: 'numeric'
                                })}</time>` : ''
                            }
                        </div>
                    </div>
                `);
                timeline.append(timelineItem);
            });
        }

        function updateActionButtons(statusData) {
            const actionSection = $('.order-actions');
            actionSection.empty();
            
            if (statusData.canReorder) {
                actionSection.append(`
                    <button class="btn btn-primary" onclick="reorderItems(${currentOrderId})">
                        <i class="fas fa-redo"></i>
                        Đặt lại đơn hàng này
                    </button>
                `);
            }
            
            if (statusData.canCancel) {
                actionSection.append(`
                    <button class="btn btn-danger" onclick="cancelOrder(${currentOrderId})">
                        <i class="fas fa-times"></i>
                        Hủy đơn hàng
                    </button>
                `);
            }

            // Ẩn/hiện section nếu không có nút nào
            const orderSection = actionSection.closest('.order-section');
            if (actionSection.children().length === 0) {
                orderSection.hide();
            } else {
                orderSection.show();
            }
        }

         function showStatusChangeNotification(oldStatus, newStatus) {
            // Tạo toast notification
            const notification = $(`
                <div class="status-notification" style="
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #28a745;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 5px;
                    z-index: 9999;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    animation: slideInRight 0.5s ease-out;
                ">
                    <i class="fas fa-check-circle"></i>
                    <strong>Trạng thái đơn hàng đã cập nhật!</strong><br>
                    <small>"${oldStatus}" → "${newStatus}"</small>
                </div>
            `);
            
            $('body').append(notification);
            
            // Tự động ẩn sau 5 giây
            setTimeout(() => {
                notification.fadeOut(500, function() {
                    $(this).remove();
                });
            }, 1000);
        } 

        function reorderItems(orderId) {
            if (confirm('Bạn có muốn đặt lại các sản phẩm trong đơn hàng này?')) {
                // Implementation for reordering
                window.location.href = '/Menu/MonNgonPhaiThu';
            }
        }

        function cancelOrder(orderId) {
            if (confirm('Bạn có chắc chắn muốn hủy đơn hàng này?\n\nLưu ý: \n- Chỉ có thể hủy đơn hàng khi đang ở trạng thái "Chờ xác nhận"\n- Đơn hàng đã được xác nhận bởi cửa hàng không thể hủy\n- Đơn hàng đã hủy không thể khôi phục')) {
                // Implementation for canceling order
                fetch(`/Account/CancelOrder/${orderId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Cập nhật trạng thái ngay lập tức thay vì chuyển trang
                        checkOrderStatus();
                        showStatusChangeNotification(lastStatusName, 'Đã hủy');
                    } else {
                        alert(data.message || 'Có lỗi xảy ra khi hủy đơn hàng.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi hủy đơn hàng.');
                });
            }
        }

        // Dừng polling khi rời khỏi trang
        $(window).on('beforeunload', function() {
            stopOrderStatusPolling();
        });

        // Dừng polling khi tab không được focus (tùy chọn để tiết kiệm tài nguyên)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopOrderStatusPolling();
                console.log('🔇 Tab hidden - polling stopped');
            } else {
                startOrderStatusPolling();
                console.log('🔊 Tab visible - polling resumed');
            }
        });
    </script>

    <style>
        /* Animation cho hiệu ứng status update */
        .status-updated {
            animation: pulse 0.5s ease-in-out;
        }

        @@keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @@keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Hiệu ứng hover cho timeline items */
        .timeline-item {
            transition: all 0.3s ease;
        }

        .timeline-item.completed {
            animation: fadeInUp 0.5s ease-in-out;
        }

        @@keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
} 