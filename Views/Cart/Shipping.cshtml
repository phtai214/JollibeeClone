@model JollibeeClone.ViewModels.CheckoutShippingViewModel
@{
    ViewData["Title"] = "Th√¥ng tin ƒë∆°n h√†ng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="~/css/checkout-shipping.css" />

<div class="checkout-container">
    <!-- Checkout Progress Steps -->
    <div class="checkout-progress">
        <div class="progress-step completed">
            <div class="step-number">
                <i class="fas fa-check"></i>
            </div>
            <span class="step-title">TH√îNG TIN KH√ÅCH H√ÄNG</span>
        </div>
        <div class="progress-arrow"></div>
        <div class="progress-step active">
            <div class="step-number">2</div>
            <span class="step-title">TH√îNG TIN ƒê∆†N H√ÄNG</span>
        </div>
        <div class="progress-arrow"></div>
        <div class="progress-step">
            <div class="step-number">3</div>
            <span class="step-title">HO√ÄN T·∫§T THANH TO√ÅN</span>
        </div>
    </div>
    
    <!-- Page Title -->
    <div class="page-title">
        <h1>TH√îNG TIN ƒê∆†N H√ÄNG</h1>
    </div>

    <div class="checkout-content">
        <div class="checkout-left">
            <form asp-action="ProcessShipping" method="post" id="checkoutForm">
                @Html.AntiForgeryToken()
                
                <!-- Hidden fields to preserve data -->
                <input type="hidden" asp-for="IsUserLoggedIn" />
                <input type="hidden" asp-for="SubtotalAmount" />
                <input type="hidden" asp-for="ShippingFee" />
                <input type="hidden" asp-for="DiscountAmount" />
                <input type="hidden" asp-for="TotalAmount" />
                
                <!-- Hidden fields for cart items -->
                @for (int i = 0; i < Model.CartItems.Count; i++)
                {
                    <input type="hidden" asp-for="CartItems[i].CartItemID" />
                    <input type="hidden" asp-for="CartItems[i].ProductID" />
                    <input type="hidden" asp-for="CartItems[i].ProductName" />
                    <input type="hidden" asp-for="CartItems[i].ProductImage" />
                    <input type="hidden" asp-for="CartItems[i].Quantity" />
                    <input type="hidden" asp-for="CartItems[i].UnitPrice" />
                    <input type="hidden" asp-for="CartItems[i].ConfigurationDescription" />
                }
                
                @if (!ViewData.ModelState.IsValid)
                {
                    <div class="alert alert-danger">
                        <h6>Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin:</h6>
                        <ul class="mb-0">
                            @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                            {
                                <li>@error.ErrorMessage</li>
                            }
                        </ul>
                    </div>
                }
                <!-- Customer Information Section -->
                <div class="checkout-section">
                    <div class="section-header">
                        <h3 class="section-title">GIAO H√ÄNG ƒê·∫æN</h3>
                        <button type="button" class="edit-delivery-btn">
                            <i class="fas fa-edit"></i> C·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ m·ªõi 
                        </button>
                    </div>
                    <div class="customer-info">
                        <div class="info-display">
                            <div class="customer-name">
                                <input asp-for="CustomerFullName" 
                                       class="form-control customer-input" 
                                       placeholder="H·ªç t√™n" />
                                <span asp-validation-for="CustomerFullName" class="text-danger"></span>
                            </div>
                            <div class="customer-phone">
                                <input asp-for="CustomerPhoneNumber" 
                                       class="form-control customer-input" 
                                       placeholder="S·ªë ƒëi·ªán tho·∫°i" />
                                <span asp-validation-for="CustomerPhoneNumber" class="text-danger"></span>
                            </div>
                            <div class="customer-email">
                                <input asp-for="CustomerEmail" 
                                       class="form-control customer-input" 
                                       placeholder="Email" 
                                       type="email" />
                                <span asp-validation-for="CustomerEmail" class="text-danger"></span>
                            </div>
                        </div>
                        
                        @if (Model.IsUserLoggedIn && Model.UserAddresses.Any())
                        {
                            <div class="address-selection">
                                <label class="form-label">Ch·ªçn ƒë·ªãa ch·ªâ giao h√†ng:</label>
                                <select asp-for="UserAddressID" 
                                        class="form-select" 
                                        id="addressSelect">
                                    <option value="">Nh·∫≠p ƒë·ªãa ch·ªâ m·ªõi...</option>
                                    @foreach (var address in Model.UserAddresses)
                                    {
                                        <option value="@address.AddressID">
                                            @address.FullName - @address.PhoneNumber - @address.Address
                                        </option>
                                    }
                                </select>
                            </div>
                        }
                        
                        <!-- Always show manual address field -->
                        <div class="manual-address" style="margin-top: 15px;">
                            <label class="form-label">
                                @if (Model.IsUserLoggedIn && Model.UserAddresses.Any())
                                {
                                    <span>Ho·∫∑c nh·∫≠p ƒë·ªãa ch·ªâ m·ªõi:</span>
                                }
                                else
                                {
                                    <span>ƒê·ªãa ch·ªâ giao h√†ng:</span>
                                }
                            </label>
                            <textarea asp-for="DeliveryAddress" 
                                      class="form-control" 
                                      rows="3" 
                                      placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng chi ti·∫øt"></textarea>
                            <span asp-validation-for="DeliveryAddress" class="text-danger"></span>
                        </div>
                        

                    </div>
                </div>

                <!-- Delivery Method Section -->
                <div class="checkout-section">
                    <h3 class="section-title">PH∆Ø∆†NG TH·ª®C V·∫¨N CHUY·ªÇN</h3>
                    <div class="delivery-methods-new">
                        @if (Model.DeliveryMethods.Any())
                        {
                            @foreach (var method in Model.DeliveryMethods)
                            {
                                <div class="delivery-method-item">
                                    <input type="radio" 
                                           asp-for="DeliveryMethodID" 
                                           value="@method.DeliveryMethodID" 
                                           id="delivery_@method.DeliveryMethodID" 
                                           class="delivery-radio-new" />
                                    <label for="delivery_@method.DeliveryMethodID" class="delivery-label-new">
                                        <span class="radio-indicator"></span>
                                        <span class="delivery-text">
                                            @method.MethodName
                                            @if (method.MethodName.Contains("giao h√†ng") || method.MethodName.Contains("ship"))
                                            {
                                                @if (method.DeliveryMethodID == Model.DeliveryMethodID)
                                                {
                                                    @if (Model.ShippingFee == 0 && Model.IsFreeship)
                                                    {
                                                        <span class="delivery-description" style="color: #28a745;">(Mi·ªÖn ph√≠)</span>
                                                    }
                                                    else if (Model.ShippingFee == 0)
                                                    {
                                                        <span class="delivery-description">(0‚Ç´)</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="delivery-description" style="color: #dc3545;">(+@Model.ShippingFee.ToString("N0")‚Ç´)</span>
                                                    }
                                                }
                                                else
                                                {
                                                    <span class="delivery-description">(T√≠nh sau)</span>
                                                }
                                            }
                                            else
                                            {
                                                <span class="delivery-description">(0‚Ç´)</span>
                                            }
                                        </span>
                                    </label>
                                </div>
                            }
                        }
                        <span asp-validation-for="DeliveryMethodID" class="text-danger"></span>
                    </div>
                </div>

                <!-- Store Selection (for pickup) -->
                <div class="checkout-section store-pickup-section" style="display: none;">
                    <div class="store-selection">
                        <div class="form-group">
                            <label class="form-label">T·ªânh th√†nh</label>
                            <select class="form-select" id="citySelect">
                                <option value="H·ªì Ch√≠ Minh">H·ªì Ch√≠ Minh</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">C·ª≠a h√†ng</label>
                            <select asp-for="StoreID" class="form-select" id="storeSelect">
                                <option value="">Ch·ªçn c·ª≠a h√†ng...</option>
                                @foreach (var store in Model.Stores)
                                {
                                    <option value="@store.StoreID" data-address="@store.StreetAddress, @store.District, @store.City">
                                        @store.StoreName - @store.StreetAddress, @store.District
                                    </option>
                                }
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Ng√†y nh·∫≠n h√†ng</label>
                            <select asp-for="PickupDate" class="form-select" id="pickupDateSelect">
                                <option value="">Ch·ªçn ng√†y nh·∫≠n h√†ng</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Th·ªùi gian nh·∫≠n h√†ng</label>
                            <select asp-for="PickupTimeSlot" class="form-select">
                                <option value="">Ch·ªçn th·ªùi gian nh·∫≠n h√†ng *</option>
                                @foreach (var timeSlot in Model.AvailableTimeSlots)
                                {
                                    <option value="@timeSlot.Value">@timeSlot.Text</option>
                                }
                            </select>
                        </div>

                        <div class="pickup-note">
                            <small class="text-muted">
                                Th·ªùi gian chu·∫©n b·ªã ƒë∆°n h√†ng √≠t nh·∫•t 30 ph√∫t t√≠nh t·ª´ l√∫c ƒë·∫∑t h√†ng th√†nh c√¥ng.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Order Notes Section -->
                <div class="checkout-section">
                    <h3 class="section-title">GHI CH√ö ƒê∆†N H√ÄNG</h3>
                    <div class="order-notes">
                        <textarea asp-for="NotesByCustomer" class="form-control" rows="4" 
                                  placeholder="Ghi ch√∫"></textarea>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="checkout-actions">
                    <button type="submit" class="btn btn-primary continue-btn">
                        TI·∫æP THEO
                    </button>
                </div>
            </form>
        </div>

        <!-- Order Summary Section -->
        <div class="checkout-right">
            <div class="order-summary-card">
                <div class="summary-header">
                    <h3 class="summary-title">CHI TI·∫æT ƒê∆†N H√ÄNG</h3>
                    <button type="button" class="edit-order-btn">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>

                
                
                <div class="order-items-list">
                    @foreach (var item in Model.CartItems)
                    {
                        <div class="order-item-card">
                            <div class="item-image-wrapper">
                                <img src="@item.ProductImage" alt="@item.ProductName" class="item-image" />
                            </div>
                            <div class="item-content">
                                <div class="item-main-info">
                                    <h4 class="item-name">@item.ProductName.ToUpper()</h4>
                                    <div class="item-quantity-price">
                                        <span class="quantity-text">x @item.Quantity</span>
                                        <span class="item-price">+ @item.TotalPrice.ToString("N0") ƒë</span>
                                    </div>
                                </div>
                                
                                @if (item.ConfigurationOptions != null && item.ConfigurationOptions.Any())
                                {
                                    <div class="item-config-details">
                                        @foreach (var config in item.ConfigurationOptions)
                                        {
                                            <div class="config-item">
                                                <span class="config-quantity">@config.Quantity x</span>
                                                <span class="config-name">@config.OptionName</span>
                                                @if (!string.IsNullOrEmpty(config.VariantName))
                                                {
                                                    <span class="config-variant">@config.VariantName</span>
                                                }
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>

                <div class="order-summary-footer">
                    <div class="subtotal-info">
                        <div class="subtotal-row">
                            <span class="subtotal-label">Chi ph√≠ t·∫°m t√≠nh</span>
                            <span class="subtotal-amount">@Model.SubtotalAmount.ToString("N0")‚Ç´</span>
                        </div>
                        <div class="vat-notice">
                            <em>ƒê√£ bao g·ªìm gi√° thu·∫ø VAT 8%</em>
                        </div>
                        
                        @* Container cho ph√≠ giao h√†ng - s·∫Ω ƒë∆∞·ª£c JavaScript control ho√†n to√†n *@
                        <div id="shipping-fee-container" style="display: none;">
                            @* Dynamic shipping fee content s·∫Ω ƒë∆∞·ª£c JavaScript t·∫°o *@
                            <div class="shipping-row" id="dynamic-shipping-row" style="display: none;">
                                <span class="shipping-label">Ph√≠ giao h√†ng</span>
                                <span class="shipping-amount" id="dynamic-shipping-amount">0‚Ç´</span>
                            </div>
                        </div>
                
                    
                    <div class="total-section">
                        <div class="total-row">
                            <span class="total-label">T·ªïng C·ªông</span>
                            <span class="total-amount">@Model.TotalAmount.ToString("N0")‚Ç´</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/checkout-shipping.js"></script>
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <style>
        /* Enhanced shipping fee container control */
        #shipping-fee-container {
            transition: all 0.3s ease;
        }
        
        #shipping-fee-container.force-hide {
            display: none !important;
            visibility: hidden !important;
            opacity: 0;
        }
        
        #shipping-fee-container.force-show {
            display: block !important;
            visibility: visible !important;
            opacity: 1;
        }
        
        /* Default hidden state */
        #shipping-fee-container {
            display: none;
        }
        
        .shipping-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .shipping-label {
            font-weight: 500;
            color: #333;
        }
        
        .shipping-amount {
            font-weight: 600;
            color: #dc3545;
        }
        
        .shipping-amount.free {
            color: #28a745;
        }
    </style>
    
    <script type="text/javascript">
        // DEBUG: Log current delivery method info
        console.log('üîç DEBUG - Current delivery method info:');
        console.log('- DeliveryMethodID:', @Model.DeliveryMethodID);
        console.log('- ShippingFee:', @Model.ShippingFee);
        console.log('- IsFreeship:', @Model.IsFreeship.ToString().ToLower());
        
        // FORCE CORRECT DISPLAY based on actually selected radio button
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const selectedRadio = document.querySelector('.delivery-radio-new:checked');
                const shippingContainer = document.querySelector('#shipping-fee-container');
                
                console.log('üîç Selected radio:', selectedRadio);
                console.log('üîç Shipping container found:', !!shippingContainer);
                
                if (selectedRadio && shippingContainer) {
                    const selectedDeliveryId = parseInt(selectedRadio.value);
                    console.log('üîç Actually selected delivery ID:', selectedDeliveryId);
                    
                    // Remove all classes first
                    shippingContainer.classList.remove('force-hide', 'force-show');
                    
                    if (selectedDeliveryId === 2) {
                        console.log('üö´ FORCING HIDE shipping fee for pickup method');
                        shippingContainer.classList.add('force-hide');
                    } else if (selectedDeliveryId === 1) {
                        console.log('‚úÖ SHOWING shipping fee for delivery method');
                        shippingContainer.classList.add('force-show');
                    }
                } else {
                    console.log('‚ùå Radio or container not found');
                }
            }, 100); // Small delay to ensure DOM is ready
        });
    </script>
} 